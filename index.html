<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>N.R.T. — Record an Achievement</title>
<style>
  :root{--bg:#f6f7fb;--card:#fff;--text:#111827;--muted:#6b7280;--primary:#4f46e5;--primary-2:#4338ca;--accent:#f59e0b;--danger:#ef4444;--ok:#10b981;--chip:#eef2ff;}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial}
  .wrap{max-width:1100px;margin:28px auto;padding:0 16px}
  .card{background:var(--card);border-radius:16px;box-shadow:0 12px 28px rgba(20,20,40,.06);border:1px solid #e5e7eb}
  .titlebar{padding:18px 20px;border-bottom:1px solid #e5e7eb}
  h1{font-size:22px;margin:0} .muted{color:var(--muted);font-size:12px;margin-top:2px}
  .section{padding:18px 20px}
  .grid{display:grid;gap:12px} .g2{grid-template-columns:1fr 1fr} .g3{grid-template-columns:1fr 1fr 1fr}
  label{font-weight:650;font-size:12px;margin-bottom:6px;display:block}
  input[type="text"],input[type="number"],input[type="date"]{width:100%;padding:10px 12px;border:1px solid #d1d5db;border-radius:10px;background:#fff;outline:none}
  input[readonly]{background:#f9fafb;color:#6b7280}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .btn{border:0;border-radius:10px;padding:10px 14px;font-weight:650;cursor:pointer}
  .btn.primary{background:var(--primary);color:#fff}
  .btn.primary:hover{background:var(--primary-2)}
  .btn.ghost{background:var(--chip);color:#3730a3}
  .btn.warn{background:var(--accent);color:#fff}
  .btn.danger{background:var(--danger);color:#fff}
  .btn.gray{background:#e5e7eb}
  .footer{padding:14px 20px;border-top:1px solid #e5e7eb;display:flex;gap:12px;position:sticky;bottom:0;background:var(--card);z-index:100;box-shadow:0 -6px 16px rgba(20,20,40,.06);padding-bottom:calc(14px + env(safe-area-inset-bottom));}
  .spacer{flex:1}
  .chip{display:inline-flex;align-items:center;background:var(--chip);padding:6px 10px;border-radius:999px;gap:8px;font-size:12px}
  .combo{position:relative}
  .dropdown{position:absolute;left:0;right:0;top:100%;background:#fff;border:1px solid #e5e7eb;border-radius:10px;margin-top:6px;max-height:220px;overflow:auto;z-index:30;box-shadow:0 10px 24px rgba(20,20,40,.08)}
  .dd-item{padding:10px 12px;cursor:pointer;border-bottom:1px solid #f3f4f6}
  .dd-item:last-child{border-bottom:0}
  .dd-item:hover{background:#f3f4f6}
  .qty{display:inline-flex;align-items:center;background:#f9fafb;border:1px solid #e5e7eb;border-radius:10px}
  .qty input{width:56px;border:0;background:transparent;text-align:center;padding:10px;appearance:textfield}
  .qty input::-webkit-outer-spin-button,.qty input::-webkit-inner-spin-button{appearance:none;margin:0}
  .qty button{border:0;background:transparent;padding:8px 10px;cursor:pointer}
  table{width:100%;border-collapse:separate;border-spacing:0 8px}
  th{font-size:12px;text-align:left;color:#6b7280;font-weight:700;padding:0 8px}
  td{background:#fff;border:1px solid #e5e7eb;padding:8px;border-radius:10px;vertical-align:middle}
  td > input, td > .qty, td > .combo input{width:100%}
  td > .qty{justify-content:center;}
  .right{text-align:right}
  .manage{background:#fafafa;border-top:1px dashed #e5e7eb}
  .pill{font-size:11px;border:1px solid #e5e7eb;border-radius:999px;padding:4px 8px;background:#fff;cursor:pointer}
  .mini-pencil{position:absolute; right:6px; top:6px; border:1px solid #e5e7eb; border-radius:999px; padding:2px 6px; font-size:12px; background:#fff; cursor:pointer; line-height:1}
  .combo{position:relative}
  @media (min-width: 769px){
    .mini-pencil{display:none}
  }

  .list{display:grid;gap:8px}
  .list .rowitem{display:grid;grid-template-columns:1fr 180px 1fr auto auto;gap:8px;align-items:center}
  .rowitem input{padding:8px 10px;border:1px solid #e5e7eb;border-radius:8px;width:100%}
  .hidden{display:none}
  .saved-card{display:flex;gap:10px;align-items:center;background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:12px}
  .saved-card .meta{font-size:12px;color:#6b7280}
  .icon-btn{background:transparent;border:0;cursor:pointer;color:#6b7280}
  .icon{width:16px;height:16px;display:inline-block}
  @media (max-width:820px){ .g2,.g3{grid-template-columns:1fr} .list .rowitem{grid-template-columns:1fr} .footer{flex-direction:column} }

/* === Modern UI refresh (mobile-first, iOS/Android friendly) === */
:root{
  --bg:#f7f8fb;
  --card:#ffffff;
  --text:#0f172a;
  --muted:#64748b;
  --primary:#4f46e5;
  --primary-2:#4338ca;
  --ring:#a5b4fc;
  --danger:#ef4444;
  --accent:#f59e0b;
}
html,body{font-size:16px;}
body{background:radial-gradient(1200px 800px at 10% -10%, #f1f5ff 0%, #f7f8fb 40%, #f7f8fb 100%) fixed;}
.wrap{max-width:1100px;margin:28px auto;padding:0 16px;}

/* Inputs */
input[type="text"],input[type="number"],input[type="date"]{
  border-radius:12px;
  min-height:44px;
  border:1px solid #e2e8f0;
  transition:box-shadow .15s ease, border-color .15s ease, background-color .15s ease;
  box-shadow:0 1px 2px rgba(15,23,42,.04);
}
input[type="text"]:focus, input[type="number"]:focus, input[type="date"]:focus{
  border-color:var(--ring);
  box-shadow:0 0 0 4px rgba(165,180,252,.25);
}


/* Mobile layout for expanded contact row: 3 input lines, actions on 4th */
@media (max-width: 820px){
  #manageContacts .rowitem.is-expanded{
    display:grid !important;
    grid-template-columns: 1fr 1fr !important;
    grid-auto-rows: auto;
    gap: 8px !important;
    align-items: start;
  }
  #manageContacts .rowitem.is-expanded > input{
    grid-column: 1 / -1 !important; /* each input takes its own row */
  }
  #manageContacts .rowitem.is-expanded .save,
  #manageContacts .rowitem.is-expanded .del{
    display: none !important;
    grid-column: span 1 !important;
    justify-content: center;
  }
  #manageContacts .rowitem.is-expanded:focus-within .save,
  #manageContacts .rowitem.is-expanded:focus-within .del{
    display: inline-flex !important;
  }
}


/* Force Due & Grand wrappers to full width on small screens */
@media (max-width: 820px){
  .row div:has(> #due),
  .row div:has(> #grand){
    min-width:100% !important;
    width:100% !important;
    flex-basis:100% !important;
  }
}


/* Make two-column grids single-column on small screens (Date + Invoice) */
@media (max-width: 820px){
  .grid.g2{ grid-template-columns: 1fr !important; }
}


/* Mobile layout for expanded contact row: 3 input lines, actions on 4th; show actions only while editing */
@media (max-width: 820px){
  #manageContacts .rowitem.is-expanded{
    display:grid !important;
    grid-template-columns: 1fr 1fr !important;
    gap:8px !important;
    align-items:start;
  }
  #manageContacts .rowitem.is-expanded > input{ grid-column:1 / -1 !important; }
  #manageContacts .rowitem.is-expanded .save,
  #manageContacts .rowitem.is-expanded .del{ display:none !important; grid-column:span 1; justify-content:center; }
  #manageContacts .rowitem.is-expanded:focus-within .save,
  #manageContacts .rowitem.is-expanded:focus-within .del{ display:inline-flex !important; }
}


/* Make two-column grids single-column on small screens (Date + Invoice full width) */
@media (max-width: 820px){
  .grid.g2{ grid-template-columns: 1fr !important; }
}

/* Buttons */
.btn{border-radius:12px;padding:12px 16px;font-weight:700;min-height:44px;transition:transform .06s ease, box-shadow .15s ease, background-color .15s ease;}
.btn:active{transform:translateY(1px);}
.btn.primary{
  background:linear-gradient(180deg, var(--primary) 0%, var(--primary-2) 100%);
  box-shadow:0 8px 16px rgba(79,70,229,.18);
}
.btn.primary:hover{filter:brightness(1.02);}
.btn.ghost{background:#eef2ff;color:#3730a3;}
.btn.warn{background:#f59e0b;color:#fff;box-shadow:0 8px 16px rgba(245,158,11,.18)}
.btn.danger{background:#ef4444;color:#fff;box-shadow:0 8px 16px rgba(239,68,68,.18)}

/* Card + title */
.card{border-radius:20px;box-shadow:0 20px 40px rgba(2,6,23,.06);border:1px solid #e2e8f0;}
.titlebar h1{font-size:24px}
.muted{color:var(--muted)}

/* Table */
table{border-collapse:separate;border-spacing:0 10px;}
td{background:#fff;border-top-left-radius:12px;border-bottom-left-radius:12px}

/* Sticky actions */
.footer{position:sticky;bottom:0;z-index:20;background:linear-gradient(180deg, rgba(255,255,255,.86), #fff);backdrop-filter:blur(8px);border-top:1px solid #e2e8f0;padding:14px 16px;gap:12px}
@supports(padding: max(0px)){
  .footer{padding-bottom:calc(14px + env(safe-area-inset-bottom))}
}

/* Dropdowns */
.dropdown{border:1px solid #e2e8f0;border-radius:12px;box-shadow:0 12px 24px rgba(2,6,23,.08)}
.dd-item{padding:10px 12px;font-size:14px;border-bottom:1px solid #f1f5f9}
.dd-item:hover{background:#f8fafc}

/* Chips / toggles */
.chip{background:#f1f5ff;color:#3730a3}

/* Responsive */
@media (max-width: 768px){
  .g2,.g3{grid-template-columns:1fr !important}
  .footer{flex-direction:column}
}

/* === Modal popups for Manage sections (overlay, no scrolling to bottom) === */
.manage {
  position: fixed;
  top: 6vh;
  left: 50%;
  transform: translateX(-50%);
  width: min(980px, calc(100vw - 40px));
  max-height: 88vh;
  overflow: auto;
  background: var(--card);
  border: 1px solid #e5e7eb;
  box-shadow: 0 24px 60px rgba(20,20,40,.18);
  border-radius: 16px;
  z-index: 1000;
  padding: 16px;
}
.manage.hidden{ display:none; } /* keep hidden behavior */
body.has-modal{ overflow:hidden; } /* lock body scroll when modal open */
/* When types & models are shown together, make them tidy columns */
#manageCatalog .grid.g2{ grid-template-columns: 1fr 1fr; gap: 16px; }
#manageCatalog .section{ background:transparent; border:0; padding:0; }
#manageCatalog #closeManageTypes, 
#manageCatalog #closeManageModels{ display:none; } /* one close button at top */

/* Ensure the Manage Product Types & Models popup is tall enough on larger screens */
@media (min-width: 768px){
  #manageCatalog .list{ min-height: 300px; } /* ~5+ rows visible */
}

/* unified discount combo input */
.combo-input{display:flex;align-items:center;border:1px solid #e5e7eb;border-radius:12px;background:#fff;height:46px;overflow:hidden}
.combo-input input{border:0!important;outline:none!important;height:100%;padding:0 12px 0 12px;flex:1;background:transparent}
.combo-input select{border:0!important;background:transparent;height:100%;padding:0 10px;font-weight:600}
.combo-input:focus-within{box-shadow:0 0 0 4px rgba(59,130,246,.1);border-color:#c7d2fe}
/* ensure legacy wrapper doesn't double borders */
.discount-wrap{border:0!important;padding:0!important}

/* === Fix Pass (Header/Spacing) — 2025-08-18 ================================ */
/* toolbar */
.saved-actions{display:flex;align-items:center;gap:12px;flex-wrap:nowrap}
@media (max-width:600px){.saved-actions{overflow-x:auto}}
/* row actions */
.row-actions{display:flex;gap:10px;margin-left:auto;white-space:nowrap;flex-wrap:nowrap;min-width:fit-content}
/* header stack */
.titlebar{display:flex;align-items:center;justify-content:space-between;gap:12px}
.title-left{display:flex;flex-direction:column}
/* ========================================================================== */
</style>
<link href="manifest.json" rel="manifest"/>
<link href="icon-192x192.png" rel="icon" sizes="192x192" type="image/png"/>
<link href="icon-512x512.png" rel="icon" sizes="512x512" type="image/png"/>
<meta content="#ffffff" name="theme-color"/>
<style id="nrt-design-overrides">

/* === N.R.T. Design Overrides (Design-only) ===================================
   - Make all inputs consistent (incl. readonly: invoice, number, address, grand)
   - Make product row (qty/price/total) less bulky but finger-friendly
   - Keep system dark-mode support
============================================================================= */
/* === Center text vertically in embedded Add buttons ======================== */
#mtAdd, #mmAdd, #csTypeAdd{
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
  line-height: 1 !important;
  gap: 4px;
}
/* Remove transform from active press that breaks centering */
#mtAdd:active, #mmAdd:active, #csTypeAdd:active{
  transform: scale(0.98);
}
/* ========================================================================= */

/* === Polished style for embedded Add buttons =============================== */
#mtAdd, #mmAdd, #csTypeAdd{
  height: 34px !important;
  padding: 0 14px !important;
  border-radius: 999px !important;
  font-size: 0.92rem !important;
  font-weight: 600 !important;
  background: #ffffff !important;
  color: #4f46e5 !important; /* keep brand-ish purple tone */
  border: 1px solid rgba(79,70,229,.35) !important;
  transition: all .18s ease-in-out !important;
}

#mtAdd::before, #mmAdd::before, #csTypeAdd::before{
  content: "+"; 
  display: inline-block;
  font-weight: 700;
  margin-right: 6px;
  transform: translateY(-1px);
}

/* Hover / focus states */
#mtAdd:hover, #mmAdd:hover, #csTypeAdd:hover,
#mtAdd:focus, #mmAdd:focus, #csTypeAdd:focus{
  background: #4f46e5 !important;
  color: #ffffff !important;
  border-color: #4f46e5 !important;
  box-shadow: 0 10px 24px rgba(79,70,229,.28) !important;
}

/* Active press */
#mtAdd:active, #mmAdd:active, #csTypeAdd:active{
  transform: translateY(-50%) scale(0.98);
}
/* ========================================================================== */
/* CHG-004 header layout */
.titlebar{ display:flex !important; align-items:center !important; justify-content:space-between !important; gap:12px !important; }
.titlebar .title-actions .row{ gap:10px; }


/* === Integrate “Add” buttons inside search fields (stronger selectors) === */
/* Make the rows that contain the search inputs positioning contexts */
.row:has(#mtSearch),
.row:has(#mmSearch),
.row:has(#csSearch){
  position: relative !important;
}

/* Give room inside inputs for the button chip */
#mtSearch, #mmSearch, #csSearch{
  padding-right: 96px !important;
}

/* Place the Add buttons inside the right end of those inputs */
#mtAdd, #mmAdd, #csTypeAdd{
  position: absolute !important;
  right: 8px;
  top: 50%;
  transform: translateY(-50%);
  height: 36px;
  padding: 0 16px;
  border-radius: 999px;
  box-shadow: 0 8px 18px rgba(59,130,246,.18);
  z-index: 3;
}
/* ======================================================================== */


:root{
  --inp-h: 50px;
  --inp-r: 12px;
  --inp-b: 1.5px;
  --border: #e5e7eb;
  --surface: #ffffff;
  --text: #0f172a;
  --muted: #64748b;
  --accent: #3b82f6;
  --ring: rgba(59,130,246,.25);
  --soft: #f8fafc;
}

/* Dark mode tokens */
@media (prefers-color-scheme: dark){
  :root{
    /* Keep light UI even in dark mode (design-only) */
    --border: #d1d5db;
    --surface: #ffffff;
    --text: #0f172a;
    --muted: #64748b;
    --soft: #f8fafc;
    --ring: rgba(165,180,252,.35);
  }
}


/* Global input look */
body .wrap input[type="text"],
body .wrap input[type="number"],
body .wrap input[type="date"],
body .wrap select,
.section table td input {
  min-height: var(--inp-h) !important;
  font-size: 16px !important;
  padding: 10px 12px !important;
  border-radius: var(--inp-r) !important;
  border: var(--inp-b) solid var(--border) !important;
  background: var(--surface) !important;
  color: var(--text) !important;
  box-shadow: none !important;
}

/* Readonly fields should look like normal inputs */
#invoice, #contactPhone, #contactAddress, #grand, #savedSearch,
body .wrap input[readonly]{
  background: var(--surface) !important;
  color: var(--text) !important;
  opacity: 1 !important;
  min-height: var(--inp-h) !important;
  padding: 10px 12px !important;
  border-radius: var(--inp-r) !important;
  border: var(--inp-b) solid var(--border) !important;
}

/* Search inputs consistent */
/* Make Name/Number/Address boxes use the full available width */
#contactSearch,
#contactPhone,
#contactAddress{
  width: 100% !important;
}

#contactSearch{ min-height: var(--inp-h) !important; }

/* Product row — slimmer */
.section table tbody td{ padding-top: 8px !important; padding-bottom: 8px !important; }

/* Quantity group: compact but usable */
.qty{
  display:inline-flex; align-items:center; gap:8px;
  padding: 4px 6px !important;
  border: var(--inp-b) solid var(--border) !important;
  border-radius: 999px !important;
  background: var(--surface) !important;
}
.qty .qtyInput{
  width: 90px !important; height: 32px !important;
  border:0 !important; background:transparent !important;
  text-align:center !important; font-size:16px !important; padding:0 !important;
}
.qty .inc, .qty .dec{
  width: 28px !important; height: 28px !important; line-height: 24px !important;
  border-radius: 999px !important;
  border: var(--inp-b) solid var(--border) !important;
  background: var(--soft) !important; font-size:18px !important; padding:0 !important;
  display:inline-flex; align-items:center; justify-content:center; cursor:pointer;
}

/* Numeric fields align right */
.priceInput, .lineTotal, #due{ text-align:right !important; font-variant-numeric: tabular-nums; }
.priceInput, .lineTotal{ min-width: 120px !important; }
#due{ min-width: 180px !important; }

/* Focus ring */
body .wrap input[type="text"]:focus,
body .wrap input[type="number"]:focus,
body .wrap input[type="date"]:focus,
body .wrap select:focus {
  border-color: var(--accent) !important;
  box-shadow: 0 0 0 3px var(--ring) !important;
  outline: none !important;
}


/* === Mobile responsiveness for items table (design-only) === */
@media (max-width: 640px){
  /* Collapse table into cards to avoid horizontal scroll */
  .section table thead{ display:none !important; }
  .section table, .section table tbody, .section table tr, .section table td{ display:block !important; width:100% !important; }
  .section table tbody tr{ background:#fff; border:1px solid var(--border); border-radius:12px; padding:10px; margin-bottom:10px; }
  .section table tbody td{ border:0 !important; padding:6px 0 !important; background:transparent !important; }
  .section table tbody td.right{ text-align:left !important; }
  /* Inputs use full width on mobile */
  .priceInput, .lineTotal, #due{ min-width:0 !important; width:100% !important; }
  /* Quantity control smaller */
  .qty .qtyInput{ width:160px !important; }
}

/* Simplified popup: make inputs match main form boxes */
#catalogSimple input { 
  min-height: var(--inp-h) !important;
  font-size: 16px !important;
  padding: 10px 12px !important;
  border-radius: var(--inp-r) !important;
  border: var(--inp-b) solid var(--border) !important;
  background: var(--surface) !important;
  color: var(--text) !important;
  width: 100%;
}
#catalogSimple .row { align-items: center; }
#catalogSimple #csTypeActions { justify-content: flex-end; }

/* === Tweaks per user request === */
/* Bigger manage popup */
.manage#catalogSimple{ width:min(840px, 90vw); }
.manage#catalogSimple .dd{ max-height:320px !important; } /* show ~5+ items */

/* Inputs in manage popup styled like Due/Number boxes */
#catalogSimple input{ 
  min-height: var(--inp-h) !important;
  padding: 10px 12px !important;
  border-radius: var(--inp-r) !important;
  border: var(--inp-b) solid var(--border) !important;
  background: var(--surface) !important;
  color: var(--text) !important;
  width: 100%;
}

/* Manage Contacts inputs look like 'Due' box */
#manageContacts input{
  min-height: var(--inp-h);
  padding: 10px 12px;
  border-radius: var(--inp-r);
  border: var(--inp-b) solid var(--border);
  background: var(--surface);
  color: var(--text);
}

/* === Fix: Model input collapsing + long Save button ======================= */
/* Apply only to model lists in both popups */
#csModelsList .rowitem, #mmList .rowitem{
  display: grid !important;
  grid-template-columns: minmax(140px,1fr) auto auto !important;
  align-items: center !important;
  gap: 8px !important;
}
/* Hide the two placeholder spans used in original 5-col grid */
#csModelsList .rowitem span, #mmList .rowitem span{ display:none !important; }
/* Ensure the text input uses the full first column and doesn't shrink weirdly */
#csModelsList .rowitem input, #mmList .rowitem input{
  width: 100% !important;
  min-width: 0 !important;
  box-sizing: border-box !important;
}

/* Make Save/Delete compact pills and prevent stretching */
#csModelsList .rowitem .save, #mmList .rowitem .save,
#csModelsList .rowitem .del,  #mmList .rowitem .del{
  width: auto !important;
  display: inline-flex !important;
  align-items: center !important;
  justify-content: center !important;
  padding: 8px 14px !important;
  border-radius: 999px !important;
  font-weight: 700 !important;
  white-space: nowrap !important;
}

/* === Manage Contacts fixes (mobile + desktop) ============================= */
/* 1–4: Balanced inputs + consistent pill buttons */
#manageContacts .rowitem{
  display: grid !important;
  grid-template-columns: 1.2fr 1fr 1.2fr auto auto !important; /* Name | Phone | Address | Save | Delete */
  align-items: center !important;
  gap: 8px !important;
}

/* Inputs take full space of their columns and don't collapse */
#manageContacts .rowitem input{
  width: 100% !important;
  min-width: 0 !important;
  box-sizing: border-box !important;
}

/* Buttons: compact pill, equal sizing */
#manageContacts .rowitem .save,
#manageContacts .rowitem .del{
  padding: 10px 16px !important;
  min-width: 90px !important;
  height: 40px !important;
  display: inline-flex !important;
  align-items: center !important;
  justify-content: center !important;
  white-space: nowrap !important;
  border-radius: 999px !important;
  font-weight: 700 !important;
}

/* 5: Show Save/Delete only when editing (focus within row) */
#manageContacts .rowitem .save,
#manageContacts .rowitem .del{ display: none !important; }
#manageContacts .rowitem:focus-within .save,
#manageContacts .rowitem:focus-within .del{ display: inline-flex !important; }

/* Mobile: keep the three inputs readable; buttons still inline */
@media (max-width: 640px){
  #manageContacts .rowitem{ grid-template-columns: 1.1fr 1fr 1.1fr auto auto !important; } 
  #manageContacts .rowitem .save,
  #manageContacts .rowitem .del{ min-width: 84px !important; height: 38px !important; padding: 8px 14px !important; }
}

/* === Show Save/Delete only when row is focused (Types + Models) ========== */
#mtList .rowitem .save, #mtList .rowitem .del,
#mmList .rowitem .save, #mmList .rowitem .del,
#csModelsList .rowitem .save, #csModelsList .rowitem .del{
  display: none !important;
}
#mtList .rowitem:focus-within .save, #mtList .rowitem:focus-within .del,
#mmList .rowitem:focus-within .save, #mmList .rowitem:focus-within .del,
#csModelsList .rowitem:focus-within .save, #csModelsList .rowitem:focus-within .del{
  display: inline-flex !important;
}

/* === Desktop fix: model row Save/Delete side-by-side (no stretching) ====== */
#manageCatalog #mmList .rowitem{
  display:grid !important;
  grid-template-columns: 1fr auto auto !important; /* input | Save | Delete */
  grid-auto-flow: column !important;
  align-items:center !important;
  gap:8px !important;
}
#manageCatalog #mmList .rowitem input{
  width: 100% !important;
  min-width: 0 !important;
}
#manageCatalog #mmList .rowitem .save,
#manageCatalog #mmList .rowitem .del{
  display:inline-flex !important;
  width:auto !important;
  max-width: fit-content !important;
  padding:8px 14px !important;
  border-radius:999px !important;
  white-space:nowrap !important;
  justify-self:end !important;
}

/* === Ensure Manage Product Types & Models modal is tall =================== */
#manageCatalog{
  top: 4vh !important;
  max-height: 92vh !important;
  min-height: 70vh !important;
}
#manageCatalog .content, #manageCatalog .list{
  max-height: 70vh !important;
  overflow: auto !important;
}

/* === Solid background for type dropdown options (all devices) ============ */
#manageCatalog .dropdown{
  background: #ffffff !important;
  border: 1px solid #e5e7eb !important;
  border-radius: 12px !important;
  box-shadow: 0 10px 24px rgba(2,6,23,.08) !important;
}
#manageCatalog .dropdown .dd-item{
  background: #ffffff !important;
  padding: 12px 14px !important;
  border-bottom: 1px solid #f1f5f9 !important;
}
#manageCatalog .dropdown .dd-item:hover{ background:#f8fafc !important; }

/* === Simple Catalog modal: taller + scrollable ============================ */
#catalogSimple{
  top: 4vh !important;
  max-height: 92vh !important;
  min-height: 70vh !important;
}
#catalogSimple .row,
#catalogSimple .list{
  /* make internal sections scroll independently when long */
  max-height: 70vh !important;
  overflow: auto !important;
}

/* === Solid background + taller list for options under the search bar ====== */
#catalogSimple .dd{
  background: #ffffff !important;
  border: 1px solid #e5e7eb !important;
  border-radius: 12px !important;
  box-shadow: 0 10px 24px rgba(2,6,23,.08) !important;
  max-height: 60vh !important;   /* show lots of choices; allow scrolling */
  overflow: auto !important;
}
#catalogSimple .dd .dd-item{
  background: #ffffff !important;
  padding: 12px 14px !important;
  border-bottom: 1px solid #f1f5f9 !important;
}
#catalogSimple .dd .dd-item:hover{ background:#f8fafc !important; }
</style>
<style>
/* === Fix: ensure dropdown visible (no clipping) ========================== */
#catalogSimple { overflow: auto !important; }  /* modal scrolls itself */
#catalogSimple .row{ 
  max-height: none !important; 
  overflow: visible !important;   /* don't clip absolute dropdown */
}
#catalogSimple .dd{
  position: absolute !important;
  z-index: 2000 !important;       /* above modal content */
}
#csTypeDD{ z-index: 2001 !important; }         /* specifically for type list */
</style><style>
/* === Adjust modal height to match list height ============================ */
#catalogSimple{
  height: auto !important;
  max-height: none !important;
}
#catalogSimple .dd{
  max-height: 320px !important; /* same as desired list height */
}
</style><style>
/* === Shrink modal to content: remove tall inner caps ===================== */
#catalogSimple .row,
#catalogSimple .list{
  max-height: unset !important;
  height: auto !important;
  overflow: visible !important;
}
#catalogSimple{
  height: auto !important;
  max-height: none !important;
  top: 8vh !important;           /* slight breathing room from top */
}
</style>
<style id="nrt-upgrade-20250816">
/* === User-requested mobile Saved Entries fix === */
@media (max-width: 640px){
  .saved-card{ flex-wrap: wrap !important; align-items: flex-start !important; }
  .saved-card > .spacer{ flex-basis: 100% !important; }
  /* Put Receipt below Edit/Delete (new line) */
  .saved-card .rec{ flex-basis: 100% !important; order: 3 !important; }
}

/* === User-requested field width match === */
/* Make Invoice Number and Grand Total inputs same min-width as Due */
#invoice, #grand{ min-width: 180px !important; }

</style>
<style id="nrt-upgrade-20250816b">
/* === Saved Entries: Button sizing & alignment === */
.saved-card {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
}
.saved-card button {
  flex: 1 1 auto !important;
  min-width: unset !important;
}
.saved-card .rec {
  flex: 1 1 auto !important;
}

/* === Invoice Number same width as Number field === */
#invoice {
  width: 100% !important;
}

/* === Grand Total same width as Due field === */
#grand {
  width: 100% !important;
}

</style>
<style id="nrt-upgrade-20250816b">
/* === Saved Entries: Equal button sizes on one line === */
.saved-card {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
}
.saved-card button {
  flex: 1 1 auto !important;
  min-width: unset !important;
}
.saved-card .rec {
  flex: 1 1 auto !important;
}

/* === Invoice Number matches Number field width === */
#invoice {
  width: 100% !important;
}

/* === Grand Total matches Due field width === */
#grand {
  width: 100% !important;
}

</style>
<style id="nrt-upgrade-20250816c">
/* === Saved Entries: keep 3 buttons on one line, equal size to each other === */
.saved-card{ display:flex !important; align-items:center !important; gap:10px !important; }
.saved-card .spacer{ flex:1 1 auto !important; }
.saved-card button{ flex:0 0 auto !important; }      /* auto width like standard buttons */
.saved-card .rec{ order:unset !important; flex:0 0 auto !important; }  /* undo previous full-width */

/* === Invoice Number same visual width as Number === */
#invoice{ width:100% !important; }  /* input stretches to column width */

/* === Grand Total same visual width as Due === */
#grand{ width:100% !important; }    /* input stretches to wrapper width */
</style>
<style>
/* === Clean inline look: items table with only input borders === */
#itemsTable { border-collapse: separate; border-spacing: 0 8px; }
#itemsTable th, #itemsTable td { 
  background: transparent !important;
  border: none !important;
  box-shadow: none !important;
  padding: 6px 6px !important;
}
#itemsTable .qty {
  background: transparent !important;
  border: none !important;
  box-shadow: none !important;
  padding: 0 !important;
}
#itemsTable .qty input { height: 34px !important; }
#itemsTable .qty button { padding: 4px 8px !important; }
</style><style>
/* Remove arrows/spinners from number inputs across browsers */
input[type=number]::-webkit-inner-spin-button, 
input[type=number]::-webkit-outer-spin-button {
  -webkit-appearance: none;
  margin: 0;
}
input[type=number] {
  -moz-appearance: textfield;
}
</style>
<style id="nrt-fix-20250818">
/* CHG-001: keep action buttons at far right (desktop) */
@media (min-width: 1024px){
  .saved-card{ display:flex !important; align-items:center !important; }
  .saved-card .spacer{ margin-right: 12px !important; flex:1 1 auto !important; }
  .saved-card .row-actions{ display:flex !important; gap:8px !important; margin-left:auto !important; white-space:nowrap !important; flex-wrap:nowrap !important; min-width:fit-content !important; }
  .saved-card .row-actions .btn{ flex:0 0 auto !important; }
}

/* CHG-002: Saved Entries search bar full-width on mobile */
@media (max-width: 600px){
  #savedSearch{ width:100% !important; min-width:100% !important; flex:1 1 100% !important; }
}

/* CHG-006: On mobile, keep Clear/View Dues/Export on one line */
.saved-actions{ display:flex; gap:8px; align-items:center; flex-wrap:nowrap; }
@media (max-width: 600px){
  .saved-actions{ overflow-x:auto; -webkit-overflow-scrolling:touch; }
  .saved-actions .btn{ padding:10px 12px !important; }
}
/* ========================================================================== */
/* CHG-004 header layout */
.titlebar{ display:flex !important; align-items:center !important; justify-content:space-between !important; gap:12px !important; }
.titlebar .title-actions .row{ gap:10px; }
</style>
<style id="nrt-shared-header-parity">
/* Shared header layout + button parity */
.titlebar{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
.titlebar .title{ display:flex; flex-direction:column; gap:4px; }
.titlebar .title-actions{ display:flex; align-items:center; align-self:center; }
.titlebar .title-actions .row{ display:flex; align-items:center; gap:12px; flex-wrap:nowrap; }
/* Normalize pill buttons so iOS/Android don’t baseline-shift them */
.titlebar .title-actions .btn{ line-height:1; padding:10px 14px; margin:0; }
@media (min-width:600px){ .titlebar{ min-height:64px; } } /* steady header height */
/* Remove page-specific offsets */
.titlebar .title-actions, .titlebar .title-actions .btn{ margin-top:0 !important; transform:none !important; }
/* Global no-horizontal-scroll safeguards */
html, body { max-width: 100%; overflow-x: hidden; }
.wrap, .card, table { max-width: 100%; }
table{ table-layout: auto; }
img, canvas, svg, video{ max-width: 100%; height: auto; display: block; }
[class*="titlebar"], .toolbar, .sticky-foot{ max-width:100%; overflow-x:hidden; }
</style><style id="nrt-header-parity-final">
/* Shared header layout + parity */
.titlebar{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
.titlebar .title{ display:flex; flex-direction:column; gap:4px; }
.titlebar .title-actions{ display:flex; align-items:center; align-self:center; }
.titlebar .title-actions .row{ display:flex; align-items:center; gap:12px; flex-wrap:nowrap; }
/* Normalize pill buttons so they don't sit low */
.titlebar .title-actions .btn{
  display:inline-flex; align-items:center; justify-content:center;
  line-height:1; padding:10px 16px; height:38px; border-radius:12px; margin:0;
}
/* Keep header height steady */
@media (min-width:600px){ .titlebar{ min-height:64px; } }
/* Nuke any legacy vertical offset */
.titlebar .title-actions, .titlebar .title-actions .btn{ margin-top:0 !important; transform:none !important; }
</style>
<style id="nrt-inventory-header-styles">
/* Exact Inventory header look, scoped to <header> only */
header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;padding:14px 16px;background:#fff;border-radius:14px;box-shadow:0 10px 28px rgba(2,6,23,.08)}
header h1{font-size:22px;margin:0}
header .sub{color:#64748b;font-weight:500;font-size:13px}
header .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
header .btn{appearance:none;border:0;background:#2563eb;color:#fff;padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer;box-shadow:0 10px 28px rgba(2,6,23,.08)}
header .btn:active{transform:translateY(1px)}
header .btn.ghost{background:#eef2ff;color:#1e3a8a}
</style>
<style id="nrt-header-fix-20250818">
/* Force Inventory header parity everywhere */
header{display:flex !important; align-items:center !important; justify-content:space-between !important; margin-bottom:18px !important; padding:14px 16px !important; background:#fff !important; border-radius:14px !important; box-shadow:0 10px 28px rgba(2,6,23,.08) !important;}
header h1{font-size:22px !important; margin:0 !important;}
header .sub{color:#64748b !important; font-weight:500 !important; font-size:13px !important;}
header .row{display:flex !important; gap:10px !important; flex-wrap:wrap !important; align-items:center !important;}
header .btn{appearance:none !important; border:0 !important; background:#2563eb !important; color:#fff !important; padding:10px 14px !important; border-radius:10px !important; font-weight:700 !important; cursor:pointer !important; box-shadow:0 10px 28px rgba(2,6,23,.08) !important; line-height:1 !important; height:auto !important; min-height:auto !important;}
header .btn.ghost{background:#eef2ff !important; color:#1e3a8a !important;}
</style>
<style id="nrt-header-64">/* Unified header height and layout across pages */header{min-height:64px !important;display:flex !important;align-items:center !important;justify-content:space-between !important;gap:12px !important;}header .row, header .title-actions .row{display:flex !important;gap:12px !important;align-items:center !important;flex-wrap:nowrap !important;}</style><style id="pc-desktop-lock-1100">
/* === Desktop: lock to original app width (approx like your screenshot) === */
:root{ --app-desktop-maxw: 1100px; }  /* adjust to 1000–1200px if you prefer */

@media (min-width: 1280px){
  .wrap{
    max-width: var(--app-desktop-maxw) !important;
    width: 100% !important;
    margin-left: auto !important;
    margin-right: auto !important;
  }
}

/* === Tables: keep header/body perfectly aligned ========================= */
#itemsTable, #inventoryTable{
  table-layout: fixed !important;
  width: 100% !important;
  border-collapse: separate !important;
  border-spacing: 0 !important;
}
#itemsTable th, #itemsTable td,
#inventoryTable th, #inventoryTable td{
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* optional helpers */
.right{ text-align: right !important; }
.center{ text-align: center !important; }
</style><style id="nrt-fixes-20250819">
/* === Alignment & behavior fixes (2025-08-19) =========================== */
/* Keep natural column sizing; action column compact */
#itemsTable { table-layout: auto !important; }
#itemsTable th:last-child, #itemsTable td:last-child { width: 1%; white-space: nowrap; }
/* Center the Qty header and its column */
#itemsTable thead th:nth-child(3){ text-align:center !important; }
#itemsTable tbody td:nth-child(3){ text-align:center !important; }
/* Make sure dropdowns can overlay */
.dropdown{ z-index: 9999 !important; }
.card{ overflow: visible !important; }
/* ====================================================================== */
</style><style id="nrt-fixes-20250819-b">
/* === 2025-08-19: dropdown reliability & layout tweaks =================== */
.combo{ overflow: visible !important; }          /* dropdown inside combo shouldn't be clipped */
.wrap, .section{ overflow: visible !important; } /* allow absolutely positioned menus to show */
/* ======================================================================= */
</style>
<style id="nrt-dropdown-portalizer-css">
/* Ensure any dropdown can float above surrounding content */
.dropdown{ z-index: 99999 !important; }
.combo, .search, .section, .card, .wrap{ overflow: visible !important; }
/* Prevent tables from clipping children */
table, tbody, tr, td, th{ overflow: visible !important; }
</style>

<style id="nrt-ios-toast-css">
/* iOS-style top notification (like iPhone banners) */
#nrt-ios-toast {
  position: fixed;
  left: 50%;
  top: env(safe-area-inset-top, 8px);
  transform: translateX(-50%) translateY(-120%);
  min-width: min(520px, calc(100vw - 24px));
  background: rgba(255,255,255,.98);
  color: #0f172a;
  border: 1px solid #e2e8f0;
  border-radius: 16px;
  box-shadow: 0 18px 40px rgba(2,6,23,.18);
  padding: 10px 14px;
  z-index: 999999;
  display: grid;
  grid-template-columns: auto 1fr auto;
  gap: 10px;
  align-items: center;
  pointer-events: none;
  transition: transform .32s cubic-bezier(.2,.9,.2,1);
  font-family: ui-sans-serif, -apple-system, system-ui, Segoe UI, Roboto, Inter, Arial;
}
#nrt-ios-toast.show { transform: translateX(-50%) translateY(0); }
#nrt-ios-toast .icon {
  width: 28px; height: 28px; border-radius: 8px;
  display: grid; place-items: center; font-weight: 900;
  background: #eef2ff; color:#3730a3;
}
#nrt-ios-toast .text { display:flex; flex-direction:column; line-height:1.2; }
#nrt-ios-toast .title { font-weight: 800; font-size: 14px; }
#nrt-ios-toast .subtitle { font-size: 12px; color:#475569; margin-top:2px; }
#nrt-ios-toast .tick {
  width: 20px; height: 20px; border-radius: 999px; border:2px solid #10b981;
  display:grid; place-items:center; font-size:12px; color:#10b981; font-weight:900;
}
@media (max-width: 480px){
  #nrt-ios-toast { min-width: calc(100vw - 16px); }
}
</style>


<!-- NRT: Mobile UI polish 2025-08-25 -->
<style id="nrt-mobile-polish-20250825">
/* 1) Saved Entries: align cards perfectly with container and toolbar buttons */
@media (max-width: 640px){
  /* remove any side drift; keep equal left/right gutters */
  .saved-card{
    margin-left: 0 !important;
    margin-right: 0 !important;
    padding-left: 16px !important;
    padding-right: 16px !important;
  }
  /* ensure the 3 action buttons feel balanced on one line */
  .saved-card button{
    min-width: 0 !important;
    flex: 1 1 auto !important;
  }
}

/* 3) Manage Product Types & Models: give the options breathing room
      so the dropdown looks like it's held by the card */
#manageCatalog .dropdown,
#catalogSimple .dd{
  top: calc(100% + 10px) !important;  /* space below the search bar */
  margin-top: 0 !important;
  padding-top: 4px !important;
  border-radius: 12px !important;
  box-shadow: 0 12px 24px rgba(2,6,23,.10) !important;
}
/* keep parent from clipping the dropdown */
#manageCatalog .row,
#catalogSimple .row,
#manageCatalog,
#catalogSimple{ overflow: visible !important; }
</style>

</head>
<body><div class="wrap">
<div class="card">
<header><div><h1>N.R.T.</h1><div class="sub">Record an Achievement</div></div><div class="row"><button class="btn ghost" onclick="location.href='dashboard.html'">Dashboard</button><button class="btn ghost" onclick="location.href='inventory.html'">Inventory</button></div></header>
<!-- Primary form fields -->
<div class="section grid g2">
<div>
<label>Date *</label>
<input id="date" type="date"/>
</div>
<div>
<label>Invoice Number</label>
<input id="invoice" readonly=""/>
</div>
<div class="combo" style="grid-column:1 / -1;">
<div class="row" style="justify-content:space-between; width:100%">
<label>Name *</label>
<button class="icon-btn" id="openManageContacts" title="Manage Contacts">
<svg class="icon" fill="none" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24">
<path d="M12 20h9"></path>
<path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"></path>
</svg>
</button>
</div>
<input id="contactSearch" placeholder="Search or add contact..." type="text"/>
<div class="dropdown hidden" id="contactDD"></div>
<div class="hidden" id="inlineAddContact" style="margin-top:6px;">
<span class="chip">Add "<span id="inlineName"></span>"
              <button class="btn ghost" id="inlineAddBtn" style="padding:4px 8px;margin-left:6px;" type="button">Open Manage</button>
</span>
</div>
</div>
<div>
<label>Number</label>
<input id="contactPhone" placeholder="Auto-filled from contact" readonly=""/>
</div>
<div>
<label>Address</label>
<input id="contactAddress" placeholder="Auto-filled from contact" readonly=""/>
</div>
</div>
<!-- Line items -->
<div class="section">
<table id="itemsTable">
<thead>
<tr>
<th>Product Type <button class="pill" id="openManageTypes" title="Manage Product Types" type="button">✎</button></th>
<th>Model <button class="pill" id="openManageModels" title="Manage Models" type="button">✎</button></th>
<th class="right">Qty</th>
<th class="right">Price (BDT)</th>
<th class="right">Line Total</th>
<th></th>
</tr>
</thead>
<tbody id="itemsBody"></tbody>
</table>
<div class="row" style="margin-top:8px">
<button class="btn warn" id="addItem" type="button">Add Item</button>
<div class="spacer"></div>
<div style="min-width:220px">
<label>Due (optional)</label>
<input id="due" min="0" step="1" type="number" value="0"/>
</div>
<div style="min-width:260px"><label>Discount (optional)</label><div class="combo-input"><input id="discountVal" min="0" placeholder="0" step="0.01" type="number"/><select id="discountType"><option value="%">%</option><option value="BDT">BDT</option></select></div></div><div style="min-width:220px">
<label>Grand Total</label>
<input id="grand" readonly="" value="0.00"/>
</div>
</div>
</div>
<div class="footer">
<label class="chip"><input id="keepContact" style="margin-right:6px" type="checkbox"/> Keep contact after submit</label>
<div class="spacer"></div>
<button class="btn primary" id="submit" style="flex:1" type="button">Submit</button>
<button class="btn ghost" id="clear" style="flex:1" type="button">Clear Form</button>
</div>
<!-- Manage Contacts -->
<div class="section manage hidden" id="manageContacts">
<div class="row" style="justify-content:space-between; margin-bottom:6px">
<strong>Manage Contacts</strong>
<button class="btn gray" id="closeManageContacts" type="button">Close</button>
</div>
<div class="row" style="margin-bottom:10px">
<input class="rowitem-input" id="mcName" placeholder="Store Name"/>
<input class="rowitem-input" id="mcPhone" placeholder="01XXXXXXXXX or +88"/>
<input class="rowitem-input" id="mcAddr" placeholder="Address"/>
<button class="btn primary" id="mcAdd" type="button">Add</button>
</div>
<div class="list" id="mcList"></div>
</div>
<!-- Manage Catalog (Types + Models together) -->
<div class="manage hidden" id="manageCatalog">
<div class="row" style="justify-content:space-between; margin-bottom:6px">
<strong>Manage Product Types &amp; Models</strong>
<button class="btn gray" id="closeManageCatalog" type="button">Close</button>
</div>
<div class="grid g2">
<!-- Manage Types (unchanged inner controls) -->
<div class="section" id="manageTypes" style="background:transparent;border:0;padding:0">
<div class="row" style="justify-content:space-between; margin-bottom:6px">
<strong>Manage Product Types</strong>
<button class="btn gray" id="closeManageTypes" style="display:none" type="button">Close</button>
</div>
<div class="row" style="margin-bottom:10px">
<input class="rowitem-input" id="mtSearch" placeholder="Search or add type"/>
<button class="btn primary" id="mtAdd" type="button">Add</button>
</div>
<div class="list" id="mtList"></div>
</div>
<!-- Manage Models (unchanged inner controls) -->
<div class="section" id="manageModels" style="background:transparent;border:0;padding:0">
<div class="row" style="justify-content:space-between; margin-bottom:6px">
<strong>Manage Models</strong>
<button class="btn gray" id="closeManageModels" style="display:none" type="button">Close</button>
</div>
<div class="row" style="margin-bottom:10px">
<input class="rowitem-input" id="mmSearch" placeholder="Search or add model"/>
<button class="btn primary" id="mmAdd" type="button">Add</button>
</div>
<div class="list" id="mmList"></div>
</div>
</div>
</div>
<!-- Simplified Catalog Popup (non-invasive) -->
<div class="manage hidden" id="catalogSimple">
<div class="row" style="justify-content:space-between; margin-bottom:6px">
<strong>Manage Product Types &amp; Models</strong>
<button class="btn gray" id="csClose" type="button">Close</button>
</div>
<!-- 2: Only a search bar -->
<div class="row" style="gap:8px; margin-bottom:10px; position:relative">
<input class="rowitem-input" id="csSearch" placeholder="Search or add product type"/>
<button class="btn primary" id="csTypeAdd" style="display:none" type="button">Add</button>
<div class="dd hidden" id="csTypeDD" style="max-height:220px; overflow:auto; position:absolute; top:48px; left:0; right:0; z-index:5"></div>
</div>
<!-- 6: Edit/Delete for selected product -->
<div class="row hidden" id="csTypeActions" style="gap:8px; margin-bottom:10px">
<button class="btn primary" id="csTypeEdit" type="button">Save</button>
<button class="btn danger" id="csTypeDelete" type="button">Delete</button>
</div>
<!-- 7: Models for selected product -->
<div class="hidden" id="csModelsWrap">
<div class="row" style="justify-content:space-between; margin-bottom:6px">
<strong id="csModelsTitle">Models</strong>
</div>
<div class="list" id="csModelsList"></div>
</div>
<!-- 9: Add model box (only after adding a new product) -->
<div class="row hidden" id="csModelAddWrap" style="gap:8px; margin-top:10px">
<input class="rowitem-input" id="csModelInput" placeholder="Add a model"/>
<button class="btn primary" id="csModelAdd" type="button">Add Model</button>
</div>
</div>
<!-- Saved Entries -->
<div class="section">
<div class="row" style="justify-content:space-between; margin-bottom:6px">
<strong>Saved Entries</strong>
<div class="row">
<input class="rowitem-input" id="savedSearch" placeholder="Search by name / phone / invoice / date" style="min-width:240px"/><div class="saved-actions"><button class="btn gray" id="clearFilters" type="button">Clear Filters</button><button class="btn ghost" id="viewDues" type="button">View Dues</button><button class="btn warn" id="exportCSV" type="button">Export (.csv)</button></div>
</div>
</div>
<div class="grid" id="savedList" style="gap:10px"></div>
</div>
</div>
</div>
<script>
(function(){
  // === Google Sheet Sync (rows) + Offline Queue ===
  const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx-LF5EXHW0Zi2tYrsE61OVVPNlYHKzyVMw1uaNfhdX1CRsAEbmKBrft8N55dWHSG9ARg/exec';
  const OFFLINE_Q_KEY = 'nrt_offline_queue';

  function readQueue(){ try{ return JSON.parse(localStorage.getItem(OFFLINE_Q_KEY))||[]; }catch{ return []; } }
  function writeQueue(q){ localStorage.setItem(OFFLINE_Q_KEY, JSON.stringify(q)); }

  function rowsFromEntry(entry){
    const rows = [];
    (entry.items||[]).forEach(it => {
      const total = Number(it.qty||0) * Number(it.price||0);
      rows.push({
        Invoice: entry.invoice,
        Subtotal: Number(entry.subtotal||0),
        DiscountType: entry.discountType || '%',
        DiscountVal: Number(entry.discountVal||0),
        Discount: Number(entry.discount||0),
        Grand: Number(entry.grand||0),
        Date: entry.date,
        Name: entry.store,
        Number: entry.phone || '',
        Address: entry.address || '',
        Product: it.type,
        Model: it.model,
        Quantity: Number(it.qty||0),
        Price: Number(it.price||0),
        Total: total,
        Due: Number(entry.due||0)
      });
    });
    return rows;
  }

  async function sendRows(rows){
    try {
      // Note: 'no-cors' returns an opaque response; we assume success if fetch resolves.
      await fetch(GOOGLE_APPS_SCRIPT_URL, {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ rows })
      });
      return true;
    } catch (e) {
      return false;
    }
  }

  
  // Storage Keys
  const K = {
    contacts: 'nrt_contacts',
    types: 'nrt_types',
    models: 'nrt_models', // { type: [models] }
    entries: 'nrt_entries_v2',
    invoiceSeq: 'nrt_invoice_seq'
  };

  // Helpers
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const read = (k, d) => { try{ const v = JSON.parse(localStorage.getItem(k)); return v ?? d; } catch { return d; } };
  const write = (k, v) => localStorage.setItem(k, JSON.stringify(v));
  const pad5 = n => String(n).padStart(5, '0');
  const validBD = p => /^(?:\+?88)?01[3-9]\d{8}$/.test(String(p||'').trim());

  // State
  let contacts = read(K.contacts, []); // {name, phone, address}
  let types = read(K.types, ['Phone Charger','Ear Buds','USB Cable','Ear Phone']);
  let models = read(K.models, { 'Phone Charger':['20W','30W'], 'Ear Buds':['TWS-1'], 'USB Cable':['Type-C'], 'Ear Phone':['Wired'] });
  
  window.types = types; window.models = models;
let entries = read(K.entries, []);

  // Init invoice
  function nextInvoiceFromSeq(){
    let seq = Number(localStorage.getItem(K.invoiceSeq) || 0);
    return 'nrt-inv-' + pad5(seq+1);
  }
  function bumpInvoice(){
    let seq = Number(localStorage.getItem(K.invoiceSeq) || 0);
    localStorage.setItem(K.invoiceSeq, String(seq+1));
  }
  $('#invoice').value = nextInvoiceFromSeq();

  // Date default today
  function today(){
    const d=new Date();
    const mm=String(d.getMonth()+1).padStart(2,'0');
    const dd=String(d.getDate()).padStart(2,'0');
    return `${d.getFullYear()}-${mm}-${dd}`;
  }
  $('#date').value = today();

  // Contact combobox
  const contactInput = $('#contactSearch');
  const contactDD = $('#contactDD');
  const inlineAdd = $('#inlineAddContact');
  const inlineName = $('#inlineName');

  function renderContactDD(list){
    contactDD.innerHTML = '';
    if(list.length===0){ contactDD.classList.add('hidden'); return; }
    list.forEach((c)=>{
      const div=document.createElement('div');
      div.className='dd-item';
      div.textContent = `${c.name} — ${c.phone||''}`.trim();
      div.onclick = async ()=>{
        contactInput.value = c.name;
        $('#contactPhone').value = c.phone || '';
        $('#contactAddress').value = c.address || '';
        contactDD.classList.add('hidden');
        inlineAdd.classList.add('hidden');
      };
      contactDD.appendChild(div);
    });
    contactDD.classList.remove('hidden');
  }
  function contactMatches(q){
    q=q.toLowerCase();
    return contacts.filter(c => c.name.toLowerCase().includes(q) || (c.phone||'').includes(q) || (c.address||'').toLowerCase().includes(q));
  }
  function showAllContacts(){ renderContactDD(contacts); }

  contactInput.addEventListener('focus', showAllContacts);
  contactInput.addEventListener('click', showAllContacts);
  document.addEventListener('click', (e)=>{
    if(!contactDD.contains(e.target) && e.target!==contactInput){ contactDD.classList.add('hidden'); }
  });
  contactInput.addEventListener('input', ()=>{
    const q = contactInput.value.trim();
    renderContactDD(contactMatches(q));
    const exists = contacts.some(c => c.name.toLowerCase() === q.toLowerCase());
    if(q && !exists){ $('#inlineName').textContent = q; inlineAdd.classList.remove('hidden'); }
    else{ inlineAdd.classList.add('hidden'); }
  });
  $('#openManageContacts').onclick = async ()=>{
    if(!mcOutsideHandler){
      mcOutsideHandler = (ev)=>{
        if (performance.now() - mcJustExpandedAt < 200) return;
        const mc = document.getElementById('manageContacts');
        if(!mc || mc.classList.contains('hidden')) return;
        const expanded = mc.querySelector('.rowitem.is-expanded');
        if(!expanded) return;
        if(expanded.contains(ev.target)) return;
        renderManageContacts('');
      };
      document.addEventListener('click', mcOutsideHandler);
    }
 document.body.classList.add('has-modal'); $('#manageContacts').classList.remove('hidden'); renderManageContacts(''); };
  $('#closeManageContacts').onclick = async ()=>{
    if(mcOutsideHandler){
      document.removeEventListener('click', mcOutsideHandler);
      mcOutsideHandler = null;
    }
 $('#manageContacts').classList.add('hidden'); document.body.classList.remove('has-modal'); };
  $('#inlineAddBtn').onclick = async ()=>{ $('#manageContacts').classList.remove('hidden'); $('#mcName').value = contactInput.value.trim(); renderManageContacts(''); inlineAdd.classList.add('hidden'); };

  // Items
  const body = $('#itemsBody');
  // Track last focused product type from items table to target Manage Models Add
  let lastFocusedType = '';
  $('#itemsBody').addEventListener('focusin', (e)=>{
    const tgt = e.target;
    if(tgt && (tgt.classList.contains('typeInput') || tgt.classList.contains('modelInput'))){
      const row = tgt.closest('tr');
      const ti = row ? row.querySelector('.typeInput') : null;
      lastFocusedType = ti ? (ti.value||'').trim() : lastFocusedType;
    }
  });
  function addRow(pref={}){
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>
        <div class="combo">
          <input class="typeInput" placeholder="Type">
          <button class="mini-pencil" type="button" title="Manage Product Types">✎</button>
          <div class="dropdown hidden"></div>
        </div>
      </td>
      <td>
        <div class="combo">
          <input class="modelInput" placeholder="Model">
          <button class="mini-pencil" type="button" title="Manage Models">✎</button>
          <div class="dropdown hidden"></div>
        </div>
      </td>
      <td class="right">
        <div class="qty">
          <button class="dec" type="button">−</button>
          <input class="qtyInput" type="text" inputmode="numeric" pattern="[0-9]*" value="${pref.qty||1}">
          <button class="inc" type="button">+</button>
        </div>
      </td>
      <td class="right"><input class="priceInput" type="number" step="0.01" min="0" value="${pref.price||0}"></td>
      <td class="right"><input class="lineTotal" readonly value="0.00"></td>
      <td class="right"><button class="btn danger del" type="button">Del</button></td>
    `;
    body.appendChild(tr);
    const typeI = tr.querySelector('.typeInput');
    const typeDD = tr.querySelectorAll('.dropdown')[0];
    const modelI = tr.querySelector('.modelInput');
    const modelDD = tr.querySelectorAll('.dropdown')[1];

    if(pref.type) typeI.value=pref.type;
    if(pref.model) modelI.value=pref.model;

    function renderTypeDD(q){
      q=(q||'').toLowerCase();
      const list = types.filter(t=>t.toLowerCase().includes(q)).map(t=>({label:t}));
      typeDD.innerHTML='';
      if(list.length===0){ typeDD.classList.add('hidden'); return; }
      list.forEach(it=>{
        const d=document.createElement('div'); d.className='dd-item'; d.textContent=it.label;
        d.onclick = async ()=>{ typeI.value=it.label; lastFocusedType = it.label; typeDD.classList.add('hidden'); modelI.value=''; renderModelDD(''); };
        typeDD.appendChild(d);
      });
      typeDD.classList.remove('hidden');
    }
    function renderModelDD(q){
      q=(q||'').toLowerCase();
      const ms = models[typeI.value] || [];
      const list = ms.filter(m=>m.toLowerCase().includes(q)).map(m=>({label:m}));
      modelDD.innerHTML='';
      if(list.length===0){ modelDD.classList.add('hidden'); return; }
      list.forEach(it=>{
        const d=document.createElement('div'); d.className='dd-item'; d.textContent=it.label;
        d.onclick = async ()=>{ modelI.value=it.label; modelDD.classList.add('hidden'); };
        modelDD.appendChild(d);
      });
      modelDD.classList.remove('hidden');
    }

    typeI.addEventListener('focus', ()=>renderTypeDD(''));
    typeI.addEventListener('click', ()=>renderTypeDD(typeI.value));
    typeI.addEventListener('input', ()=>renderTypeDD(typeI.value));

    modelI.addEventListener('focus', ()=>renderModelDD(''));
    modelI.addEventListener('click', ()=>renderModelDD(modelI.value));
    modelI.addEventListener('input', ()=>renderModelDD(modelI.value));

    tr.querySelector('.dec').onclick = async ()=>{ const q=tr.querySelector('.qtyInput'); q.value=Math.max(1, (parseInt(q.value)||1)-1); recalcRow(tr); };
    tr.querySelector('.inc').onclick = async ()=>{ const q=tr.querySelector('.qtyInput'); q.value=(parseInt(q.value)||1)+1; recalcRow(tr); };
    tr.querySelector('.qtyInput').addEventListener('input', ()=>recalcRow(tr));
    tr.querySelector('.priceInput').addEventListener('input', ()=>recalcRow(tr));
    tr.querySelector('.del').onclick = async ()=>{ tr.remove(); recalcGrand(); };

    recalcRow(tr);
  }
  function recalcRow(tr){
    const q=Number(tr.querySelector('.qtyInput').value||0);
    const p=Number(tr.querySelector('.priceInput').value||0);
    tr.querySelector('.lineTotal').value = (q*p).toFixed(2);
    recalcGrand();
  }
  function recalcGrand(){
  let sum=0; $$('#itemsBody .lineTotal').forEach(x=> sum += Number(x.value||0));
  let grand = sum;
  const typeEl = document.getElementById('discountType');
  const valEl  = document.getElementById('discountVal');
  if(typeEl && valEl){
    const t = typeEl.value || '%';
    const v = Number(valEl.value||0);
    if(v>0){
      const disc = (t==='%' ? sum*v/100 : v);
      grand = Math.max(0, sum - disc);
    }
  }
  $('#grand').value = grand.toFixed(2);
}
  $('#addItem').onclick = ()=> addRow();
  // Recalc grand total live when discount fields change
  const _dv = document.getElementById('discountVal');
  const _dt = document.getElementById('discountType');
  if(_dv){ _dv.addEventListener('input', recalcGrand); }
  if(_dt){ _dt.addEventListener('change', recalcGrand); }

  addRow();

  
  // Outside click handler for auto-shrink of expanded contact rows
  let mcOutsideHandler = null;
  let mcJustExpandedAt = 0;
// Manage Contacts
  
function renderManageContacts(filter=''){
    const list = $('#mcList'); list.innerHTML='';
    const q=(filter||'').toLowerCase();
    contacts
      .filter(c => !q 
          || (c.name||'').toLowerCase().includes(q) 
          || (c.phone||'').includes(q) 
          || (c.address||'').toLowerCase().includes(q))
      .forEach((c,i)=>{
        const row=document.createElement('div'); 
        row.className='rowitem';
        // Collapsed view: show only the number as a single line button
        const numberLabel = (c.phone && c.phone.trim()) ? c.phone : '(no number)';
        row.innerHTML = `<button class="btn gray expand" type="button" style="width:100%;justify-content:flex-start">${numberLabel}</button>`;
        row.classList.remove('is-expanded');

        const expand = () => {
          mcJustExpandedAt = performance.now();
          row.innerHTML = `
            <input value="${(c.name||'').replace(/"/g,'&quot;')}">
            <input value="${(c.phone||'').replace(/"/g,'&quot;')}">
            <input value="${(c.address||'').replace(/"/g,'&quot;')}">
            <button class="btn primary save" type="button">Save</button>
            <button class="btn danger del" type="button">Delete</button>`;
                    row.classList.add('is-expanded');
const [nm,ph,ad] = row.querySelectorAll('input');
          row.querySelector('.save').onclick = async ()=>{
            const n=nm.value.trim(), p=ph.value.trim(), a=ad.value.trim();
            if(p && !validBD(p)){ alert('Phone must be a valid 11-digit Bangladeshi number'); return; }
            if(p && contacts.some((cc,j)=> j!==i && cc.phone===p)){ alert('This phone number already exists.'); return; }
            contacts[i]={name:n||'(no name)', phone:p||'', address:a||''};
            write(K.contacts, contacts);
            renderManageContacts(filter);
          };
          row.querySelector('.del').onclick = async ()=>{
            if(!(await nrtConfirm('Delete this contact?'))) return;
            contacts.splice(i,1); write(K.contacts, contacts); renderManageContacts(filter);
          };
        };
        row.querySelector('.expand').addEventListener('click', expand);
        list.appendChild(row);
      });
  }
  $('#mcName').addEventListener('input', ()=> renderManageContacts($('#mcName').value));
  $('#mcPhone').addEventListener('input', ()=> renderManageContacts($('#mcPhone').value));
  $('#mcAddr').addEventListener('input', ()=> renderManageContacts($('#mcAddr').value));
  $('#mcAdd').onclick = async ()=>{
    const n=$('#mcName').value.trim();
    const p=$('#mcPhone').value.trim();
    const a=$('#mcAddr').value.trim();
    if(!n || !p || !a){ alert('Please fill Store Name, Phone and Address.'); return; }
    if(!validBD(p)){ alert('Phone must be a valid 11-digit Bangladeshi number'); return; }
    if(contacts.some(c=>c.phone===p)){ alert('This phone number already exists.'); return; }
    contacts.push({name:n, phone:p, address:a});
    write(K.contacts, contacts);
    renderManageContacts();
    $('#mcName').value=''; $('#mcPhone').value=''; $('#mcAddr').value='';
  };


  // Manage Types
  function renderTypesManage(filter=''){
    const list=$('#mtList'); list.innerHTML='';
    const q=(filter||'').toLowerCase();
    types.filter(t=>!q || t.toLowerCase().includes(q)).forEach((t,i)=>{
      const row=document.createElement('div'); row.className='rowitem';
      row.innerHTML=`<input value="${t}"><span></span><span></span>
        <button class="btn primary save" type="button">Save</button>
        <button class="btn danger del" type="button">Delete</button>`;
      const nm=row.querySelector('input');
      row.querySelector('.save').onclick = async ()=>{
        const v=nm.value.trim(); if(!v) return;
        if(types.map(x=>x.toLowerCase()).includes(v.toLowerCase()) && v.toLowerCase()!==t.toLowerCase()){ alert('Type exists'); return; }
        if(models[t] && !models[v]){ models[v]=models[t]; delete models[t]; }
        types[i]=v; write(K.types, types); write(K.models, models); renderTypesManage(filter);
      };
      row.querySelector('.del').onclick = async ()=>{ const del=types.splice(i,1)[0]; delete models[del]; write(K.types, types); write(K.models, models); renderTypesManage(filter); };
      list.appendChild(row);
    });
  }
  $('#mtSearch').addEventListener('input', ()=> renderTypesManage($('#mtSearch').value));
  $('#mtAdd').onclick = async ()=>{
    const v=$('#mtSearch').value.trim(); if(!v) return;
    if(types.map(x=>x.toLowerCase()).includes(v.toLowerCase())){ alert('Type exists'); return; }
    types.push(v); models[v]=models[v]||[]; write(K.types, types); write(K.models, models); renderTypesManage();
    $('#mtSearch').value='';
  };

  // Manage Models
  function renderModelsManage(filter=''){
    const list=$('#mmList'); list.innerHTML='';
    const q=(filter||'').toLowerCase();
    Object.keys(models).sort().forEach(tp=>{
      const head=document.createElement('div'); head.style.fontWeight='700'; head.textContent=tp; head.style.margin='6px 0';
      list.appendChild(head);
      (models[tp]||[]).filter(m=>!q || m.toLowerCase().includes(q)).forEach((m,idx)=>{
        const row=document.createElement('div'); row.className='rowitem';
        row.innerHTML=`<input value="${m}"><span></span><span></span>
          <button class="btn primary save" type="button">Save</button>
          <button class="btn danger del" type="button">Delete</button>`;
        const nm=row.querySelector('input');
        row.querySelector('.save').onclick = async ()=>{
          const v=nm.value.trim(); if(!v) return;
          if(models[tp].map(x=>x.toLowerCase()).includes(v.toLowerCase()) && v.toLowerCase()!==m.toLowerCase()){ alert('Model exists'); return; }
          models[tp][idx]=v; write(K.models, models); renderModelsManage(filter);
        };
        row.querySelector('.del').onclick = async ()=>{ models[tp].splice(idx,1); write(K.models, models); renderModelsManage(filter); };
        list.appendChild(row);
      });
    });
  }

  
// Open/close manage panels (as modal)
  let mcatalogOutsideHandler = null;
  function openCatalog(){
    if(!mcatalogOutsideHandler){
      mcatalogOutsideHandler = (ev)=>{
        const cat = document.getElementById('manageCatalog');
        if(!cat || cat.classList.contains('hidden')) return;
        const focused = cat.querySelector('.rowitem:focus-within');
        if(!focused) return;
        if(focused.contains(ev.target)) return;
        // blur active input so :focus-within rules hide buttons
        if(document.activeElement && document.activeElement.blur) document.activeElement.blur();
      };
      document.addEventListener('click', mcatalogOutsideHandler);
    }
 document.body.classList.add('has-modal'); $('#manageCatalog').classList.remove('hidden'); renderTypesManage(''); renderModelsManage(''); }
  function closeCatalog(){
    if(mcatalogOutsideHandler){
      document.removeEventListener('click', mcatalogOutsideHandler);
      mcatalogOutsideHandler = null;
    }
 $('#manageCatalog').classList.add('hidden'); document.body.classList.remove('has-modal'); }
  $('#openManageTypes').onclick = async ()=>{ openCatalog(); };
  $('#closeManageTypes').onclick = ()=> closeCatalog();
  $('#openManageModels').onclick = async ()=>{ 
    // preserve lastFocusedType detection for add model
    let tp = (lastFocusedType||'').trim();
    if(!tp){
      const active = document.activeElement;
      if(active && active.closest && active.closest('#itemsBody tr')){
        const ti = active.closest('#itemsBody tr').querySelector('.typeInput');
        if(ti && ti.value.trim()) tp = ti.value.trim();
      }
    }
    if(!tp){
      const filled=[...document.querySelectorAll('#itemsBody .typeInput')].map(i=>i.value.trim()).filter(Boolean);
      if(filled.length) tp = filled[filled.length-1];
    }
    lastFocusedType = tp;
    openCatalog();
  };
  $('#closeManageModels').onclick = ()=> closeCatalog();
  $('#closeManageCatalog').onclick = ()=> closeCatalog();
// Manage Models – search & add
  $('#mmSearch').addEventListener('input', ()=> renderModelsManage($('#mmSearch').value));
  $('#mmAdd').onclick = async ()=>{
    const model = ($('#mmSearch').value||'').trim();
    if(!model) return;
    // Determine target product type
    let tp = (lastFocusedType||'').trim();
    if(!tp){
      const act=document.activeElement;
      if(act && act.closest && act.closest('#itemsBody tr')){
        const ti=act.closest('#itemsBody tr').querySelector('.typeInput');
        if(ti && ti.value.trim()) tp = ti.value.trim();
      }
    }
    if(!tp){
      const filled = Array.from(document.querySelectorAll('#itemsBody .typeInput')).map(i=>i.value.trim()).filter(Boolean);
      if(filled.length) tp = filled[filled.length-1];
    }
    if(!tp){ alert('Select a Product Type in the items table first.'); return; }
    // Canonicalize type to managed casing
    const canon = types.find(t => t.toLowerCase() === tp.toLowerCase()) || tp;
    tp = canon;
    models[tp] = models[tp] || [];
    if(models[tp].map(x=>x.toLowerCase()).includes(model.toLowerCase())){ alert('Model exists for this type'); return; }
    models[tp].push(model); write(K.models, models);
    renderModelsManage($('#mmSearch').value);
    $('#mmSearch').value = '';
  };

  

// ===== Simplified Catalog Popup (safe; no other logic changed) =====
(function(){
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  let csSelected = ''; // currently selected product type

  function csReset(){
    csSelected = '';
    if($('#csSearch')) $('#csSearch').value = '';
    if($('#csTypeAdd')) $('#csTypeAdd').style.display = 'none';
    if($('#csTypeDD')) $('#csTypeDD').classList.add('hidden');
    if($('#csTypeActions')) $('#csTypeActions').classList.add('hidden');
    if($('#csModelsWrap')) $('#csModelsWrap').classList.add('hidden');
    if($('#csModelsList')) $('#csModelsList').innerHTML = '';
    if($('#csModelAddWrap')) $('#csModelAddWrap').classList.add('hidden');
  }

  let csOutsideHandler = null;
  function csOpen(){
    if(!csOutsideHandler){
      csOutsideHandler = (ev)=>{
        const cs = document.getElementById('catalogSimple');
        if(!cs || cs.classList.contains('hidden')) return;
        const focused = cs.querySelector('.rowitem:focus-within');
        if(!focused) return;
        if(focused.contains(ev.target)) return;
        if(document.activeElement && document.activeElement.blur) document.activeElement.blur();
      };
      document.addEventListener('click', csOutsideHandler);
    }

    document.body.classList.add('has-modal');
    $('#catalogSimple').classList.remove('hidden');
    csReset();
  }
  function csClose(){
    if(csOutsideHandler){
      document.removeEventListener('click', csOutsideHandler);
      csOutsideHandler = null;
    }

    $('#catalogSimple').classList.add('hidden');
    document.body.classList.remove('has-modal');
  }

  // Hook pencil icons to open simplified popup
  if($('#openManageTypes'))  $('#openManageTypes').onclick  = csOpen;
  if($('#openManageModels')) $('#openManageModels').onclick = csOpen;
  if($('#csClose')) $('#csClose').onclick = csClose;

  // Delegate mini pencil clicks (mobile) to open the manager
  document.addEventListener('click', (e)=>{
    const t = e.target;
    if(t && t.classList && t.classList.contains('mini-pencil')){ csOpen(); }
  });


  // Show dropdown of existing products on focus/input
  function csRenderTypeDD(filter=''){
    const dd = $('#csTypeDD'); if(!dd) return;
    const q = (filter||'').toLowerCase();
    dd.innerHTML = '';
    const list = (window.types||[]).filter(t => !q || t.toLowerCase().includes(q));
    if(list.length === 0){ dd.classList.add('hidden'); return; }
    list.forEach(t=>{
      const item = document.createElement('div');
      item.className = 'dd-item';
      item.textContent = t;
      item.onclick = ()=> csSelectType(t);
      dd.appendChild(item);
    });
    dd.classList.remove('hidden');
  }

  function csSelectType(tp){
    csSelected = tp;
    if($('#csSearch')) $('#csSearch').value = tp;
    if($('#csTypeAdd')) $('#csTypeAdd').style.display = 'none';
    if($('#csTypeDD')) $('#csTypeDD').classList.add('hidden');
    // Show actions
    if($('#csTypeActions')) $('#csTypeActions').classList.remove('hidden');
    // Show models
    csRenderModels(tp);
    if($('#csModelAddWrap')) $('#csModelAddWrap').classList.remove('hidden');
  }

  function csRenderModels(tp){
    const wrap = $('#csModelsWrap'); const list = $('#csModelsList');
    if(!wrap || !list) return;
    list.innerHTML = '';
    const arr = (window.models||{})[tp] || [];
    arr.forEach((m, idx)=>{
      const row = document.createElement('div');
      row.className = 'rowitem';
      row.innerHTML = `<input value="${m}"><span></span><span></span>
        <button class="btn primary save" type="button">Save</button>
        <button class="btn danger del" type="button">Delete</button>`;
      const inp = row.querySelector('input');
      row.querySelector('.save').onclick = async ()=>{
        const v = (inp.value||'').trim(); if(!v) return;
        const lower = arr.map(x=>x.toLowerCase());
        if(lower.includes(v.toLowerCase()) && v.toLowerCase()!==m.toLowerCase()){ alert('Model exists'); return; }
        arr[idx] = v; window.models[tp] = arr; localStorage.setItem('nrt_models', JSON.stringify(window.models)); csRenderModels(tp);
      };
      row.querySelector('.del').onclick = async ()=>{
        arr.splice(idx,1); window.models[tp] = arr; localStorage.setItem('nrt_models', JSON.stringify(window.models)); csRenderModels(tp);
      };
      list.appendChild(row);
    });
    if($('#csModelsTitle')) $('#csModelsTitle').textContent = 'Models — ' + tp;
    wrap.classList.remove('hidden');
  }

  // Search bar behavior (4,8)
  if($('#csSearch')){
    $('#csSearch').addEventListener('focus', ()=> csRenderTypeDD($('#csSearch').value));
    $('#csSearch').addEventListener('input', ()=>{
      const v = ($('#csSearch').value||'').trim();
      const exists = (window.types||[]).map(x=>x.toLowerCase()).includes(v.toLowerCase());
      if($('#csTypeAdd')) $('#csTypeAdd').style.display = v && !exists ? 'inline-flex' : 'none';
      csRenderTypeDD(v);
    });
  }

  // 6: Save/Delete for product type
  if($('#csTypeEdit')) $('#csTypeEdit').onclick = async ()=>{
    const current = csSelected; if(!current) return;
    const v = ($('#csSearch').value||'').trim(); if(!v) return;
    if(v.toLowerCase()!==current.toLowerCase()){
      const lower = (window.types||[]).map(x=>x.toLowerCase());
      if(lower.includes(v.toLowerCase())){ alert('Type exists'); return; }
      // rename
      const idx = (window.types||[]).findIndex(t=>t===current);
      if(idx>-1) window.types[idx] = v;
      if(window.models[current]){ if(!window.models[v]) window.models[v] = window.models[current]; delete window.models[current]; }
      localStorage.setItem('nrt_types', JSON.stringify(window.types));
      localStorage.setItem('nrt_models', JSON.stringify(window.models));
      csSelectType(v);
    }
  };
  if($('#csTypeDelete')) $('#csTypeDelete').onclick = async ()=>{
    const current = csSelected; if(!current) return;
    if(!(await nrtConfirm('Delete product type and all its models?'))) return;
    window.types = (window.types||[]).filter(t=>t!==current);
    delete window.models[current];
    localStorage.setItem('nrt_types', JSON.stringify(window.types));
    localStorage.setItem('nrt_models', JSON.stringify(window.models));
    csReset();
  };

  // 8–9: Add new product then show add model box
  if($('#csTypeAdd')) $('#csTypeAdd').onclick = async ()=>{
    const v = ($('#csSearch').value||'').trim(); if(!v) return;
    const lower = (window.types||[]).map(x=>x.toLowerCase());
    if(lower.includes(v.toLowerCase())) return;
    window.types.push(v);
    /* keep existing ref */
    window.models[v] = window.models[v] || [];
    localStorage.setItem('nrt_types', JSON.stringify(window.types));
    localStorage.setItem('nrt_models', JSON.stringify(window.models));
    csSelected = v;
    if($('#csTypeActions')) $('#csTypeActions').classList.remove('hidden');
    if($('#csModelsWrap')) $('#csModelsWrap').classList.remove('hidden');
    if($('#csModelAddWrap')) $('#csModelAddWrap').classList.remove('hidden');
    if($('#csModelsTitle')) $('#csModelsTitle').textContent = 'Models — ' + v;
    csRenderModels(v);
  };

  if($('#csModelAdd')) $('#csModelAdd').onclick = async ()=>{
    const tp = csSelected; if(!tp) return;
    const m = ($('#csModelInput').value||'').trim(); if(!m) return;
    window.models[tp] = window.models[tp] || [];
    const lower = window.models[tp].map(x=>x.toLowerCase());
    if(lower.includes(m.toLowerCase())){ alert('Model exists for this type'); return; }
    window.models[tp].push(m);
    localStorage.setItem('nrt_models', JSON.stringify(window.models));
    $('#csModelInput').value='';
    csRenderModels(tp);
    if($('#csModelAddWrap')) $('#csModelAddWrap').classList.remove('hidden');
  };
})();
// Saved entries rendering
  function renderSaved(filter=''){
    entries = read(K.entries, []);
    let list = entries.slice();
    if(filter){
      const q=filter.toLowerCase();
      list = list.filter(e => (e.store||'').toLowerCase().includes(q) || (e.phone||'').includes(q) || (e.invoice||'').toLowerCase().includes(q) || (e.date||'').toLowerCase().includes(q));
    }
    const wrap = $('#savedList'); wrap.innerHTML='';
    if(list.length===0){ const p=document.createElement('div'); p.className='muted'; p.textContent='No entries found.'; wrap.appendChild(p); return; }
    list.reverse().forEach((e)=>{
      const div=document.createElement('div'); div.className='saved-card';
      div.innerHTML=`
        <div class="spacer">
          <div><strong>${e.store}</strong> • ${e.phone||''}</div>
          <div class="meta">${e.date} • Invoice ${e.invoice} • Items: ${e.items.map(i=>`${i.type}/${i.model}×${i.qty}`).join(', ')} • Discount: BDT ${Number(e.discount||0).toFixed(2)} • Grand: BDT ${Number(e.grand).toFixed(2)} • Due: BDT ${Number(e.due||0).toFixed(2)}</div>
        </div>
        <div class="row-actions"><button class="btn gray edit" type="button">Edit</button><button class="btn danger del" type="button">Delete</button><button class="btn primary rec" type="button" data-invoice="${e.invoice}">Receipt</button></div>`;
      // actions
      div.querySelector('.del').onclick = async ()=>{
        const pos = entries.findIndex(x=>x.invoice===e.invoice);
        if(pos>=0){ entries.splice(pos,1); write(K.entries, entries); renderSaved($('#savedSearch').value.trim()); }
      };
      div.querySelector('.edit').onclick = async ()=>{
        // load into form
        $('#date').value = e.date;
        $('#invoice').value = e.invoice; // keep invoice (editing)
        $('#contactSearch').value = e.store;
        $('#contactPhone').value = e.phone||'';
        $('#contactAddress').value = e.address||'';
        const body = $('#itemsBody'); body.innerHTML='';
        e.items.forEach(it=> addRow({type:it.type, model:it.model, qty:it.qty, price:it.price}));
        recalcGrand();
        $('#discountVal').value = (e.discountVal||0);
        if($('#discountType')) $('#discountType').value = (e.discountType||'%');
        $('#due').value = e.due||0;
        window.scrollTo({top:0,behavior:'smooth'});
      };
      div.querySelector('.rec').onclick = async ()=>{ generateReceiptPDF(e); };
      wrap.appendChild(div);
    });
  }
  renderSaved('');

  $('#savedSearch').addEventListener('input', ()=> renderSaved($('#savedSearch').value.trim()));
  $('#clearFilters').onclick = async ()=>{ $('#savedSearch').value=''; renderSaved(''); };
  $('#viewDues').onclick = async ()=>{
    const list = read(K.entries, []).filter(e=> Number(e.due||0) > 0 );
    const wrap=$('#savedList'); wrap.innerHTML='';
    if(list.length===0){ wrap.innerHTML='<div class="muted">No dues.</div>'; return; }
    list.forEach(e=>{
      const d=document.createElement('div'); d.className='saved-card'; d.innerHTML=`
        <div class="spacer"><strong>${e.store}</strong> — Invoice ${e.invoice}
        <div class="meta">${e.date} • Phone ${e.phone||''} • Due: BDT ${Number(e.due||0).toFixed(2)}</div></div>`;
      wrap.appendChild(d);
    });
  };

  if($('#dashboardBtn')) $('#dashboardBtn').onclick = async ()=>{ window.location.href = 'dashboard.html'; };


  // Export CSV
  
  $('#exportCSV').onclick = async ()=>{
    // Export one row per item with all form fields in requested order
    const headers = ['Invoice','Date','Name','Number','Address','Product','Model','Quantity','Price','Total','Subtotal','DiscountType','DiscountVal','Discount','Grand','Due'];
    const rows = [headers];
    const data = read(K.entries, []);
    data.forEach(e=>{
      const phoneText = e.phone ? ("'" + String(e.phone)) : '';
      (e.items||[]).forEach(i=>{
        const total = Number(i.qty||0) * Number(i.price||0);
        rows.push([e.invoice, e.date, e.store, phoneText, e.address||'', i.type, i.model, Number(i.qty||0), Number(i.price||0), total, Number(e.subtotal||0), (e.discountType||'%'), Number(e.discountVal||0), Number(e.discount||0), Number(e.grand||0), Number(e.due||0)]);
      });
    });
    const esc = v => '"' + String(v).replace(/"/g,'""') + '"';
    const csv = rows.map(r => r.map(esc).join(',')).join('\r\n');
    const blob = new Blob(['\ufeff'+csv], {type:'text/csv;charset=utf-8;'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='nrt_entries.csv'; a.click();
  };
;

  // Submit
  $('#submit').onclick = async ()=>{
    const date=$('#date').value.trim();
    const invoice=$('#invoice').value.trim();
    const name=$('#contactSearch').value.trim();
    if(!date || !invoice || !name){ alert('Please fill date, invoice and shop name'); return; }
    const phone=$('#contactPhone').value.trim();
    const address=$('#contactAddress').value.trim();
    const keep = $('#keepContact').checked;

    const items=[];
    $$('#itemsBody tr').forEach(tr=>{
      const type=tr.querySelector('.typeInput').value.trim();
      const model=tr.querySelector('.modelInput').value.trim();
      // Validation: type & model must exist in managed lists
      const typeOk = types.includes(type);
      const modelsForType = models[type] || [];
      const modelOk = modelsForType.includes(model);
      if(!(typeOk && modelOk)){
        alert('Each item must use a Product Type and Model from Manage lists.');
        throw new Error('Invalid type/model');
      }
      const qty=Number(tr.querySelector('.qtyInput').value||0);
      const price=Number(tr.querySelector('.priceInput').value||0);
      if(type && model && qty>0){ items.push({type,model,qty,price,total:qty*price}); }
    });
    if(items.length===0){ alert('Please add at least one item'); return; }
    const subtotal = items.reduce((s,i)=>s+i.total,0);
    const discType = ($('#discountType') && $('#discountType').value) || '%';
    const discVal  = ($('#discountVal') && Number($('#discountVal').value||0)) || 0;
    const discount = discVal>0 ? (discType==='%' ? subtotal*discVal/100 : discVal) : 0;
    const grand = Math.max(0, subtotal - discount);
    const due=Number($('#due').value||0);

    // Upsert contact by phone only (name/address can duplicate)
    if(phone && !validBD(phone)){ if(!(await nrtConfirm('Phone looks invalid. Continue without saving phone?'))) return; }
    if(phone){
      const idx=contacts.findIndex(c=>c.phone===phone);
      if(idx>=0) contacts[idx]={name, phone, address}; else contacts.push({name, phone, address});
      write(K.contacts, contacts);
    } else {
      const idx=contacts.findIndex(c=>c.name.toLowerCase()===name.toLowerCase() && !c.phone);
      if(idx>=0) contacts[idx]={name, phone:'', address}; else contacts.push({name, phone:'', address});
      write(K.contacts, contacts);
    }

    // Save entry
    const entry={date, store:name, phone:phone||'', address, invoice, items, subtotal, discountType:discType, discountVal:discVal, discount, grand, due};
    const existingIdx = entries.findIndex(x=> x.invoice === invoice);
    const isEdit = existingIdx >= 0;
    if(isEdit){ entries[existingIdx] = entry; } else { entries.push(entry); }
    write(K.entries, entries);

    
    // === Send to Google Sheet (now or later) ===
    (async () => {
      const rows = rowsFromEntry(entry);
      if (navigator.onLine) {
        const ok = await sendRows(rows);
        if (!ok) { const q = readQueue(); q.push({rows}); writeQueue(q); }
      } else {
        const q = readQueue(); q.push({rows}); writeQueue(q);
      }
    })();
    
    
    // === Send to Google Sheet (flat JSON object) ===
    (async () => {
      const payload = {
        Invoice: newEntry.invoiceNumber || '',
        Date: newEntry.date || '',
        Name: newEntry.storeName || '',
        Number: newEntry.mobileNumber || '',
        Address: newEntry.address || '',
        Product: newEntry.gadgetType || '',
        Model: newEntry.modelName || '',
        Quantity: Number(newEntry.quantity || 0),
        Price: Number(newEntry.sellingPrice || 0),
        Total: Number(newEntry.totalRevenue || 0),
        Subtotal: Number(newEntry.subtotal || 0),
        DiscountType: newEntry.discountType || '%',
        DiscountVal: Number(newEntry.discountVal || 0),
        Discount: Number(newEntry.discount || 0),
        Grand: Number(newEntry.grand || 0),
        Due: Number(newEntry.due || 0)
      };
      if (navigator.onLine) {
        try {
          await fetch(GOOGLE_APPS_SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type':'application/json' },
            body: JSON.stringify(payload)
          });
        } catch (e) {
          const q = JSON.parse(localStorage.getItem('nrt_offline_queue') || '[]');
          q.push(payload);
          localStorage.setItem('nrt_offline_queue', JSON.stringify(q));
        }
      } else {
        const q = JSON.parse(localStorage.getItem('nrt_offline_queue') || '[]');
        q.push(payload);
        localStorage.setItem('nrt_offline_queue', JSON.stringify(q));
      }
    })();
    alert(isEdit ? 'Updated' : 'Saved');

    renderSaved($('#savedSearch').value.trim());

    // bump invoice ONLY for new entries
    if(!isEdit){ bumpInvoice(); }
    $('#invoice').value = nextInvoiceFromSeq();
    $('#date').value=''; // clear date as requested
    $('#due').value='0';
    $('#grand').value='0.00';
    const body = $('#itemsBody'); body.innerHTML=''; addRow();
    if(!keep){ $('#contactSearch').value=''; $('#contactPhone').value=''; $('#contactAddress').value=''; }
  };

  // Clear Form (should not bump invoice; also clears date)
  $('#clear').onclick = async ()=>{
    $('#date').value='';
    $('#invoice').value = nextInvoiceFromSeq();
    $('#due').value='0';
    $('#discountVal').value='0';
    if($('#discountType')) $('#discountType').value='%';
    const body = $('#itemsBody'); body.innerHTML=''; addRow();
    recalcGrand();
    $('#contactSearch').value=''; $('#contactPhone').value=''; $('#contactAddress').value='';
  };

  // Initial renders (seed on first use for demo)
  function initialRender(){
    if(contacts.length===0){ contacts=[
      {name:'Hasan Tel', phone:'01711111111', address:'Mirpur 1'},
      {name:'Classic Mobile', phone:'01822222222', address:'Dhanmondi'},
      {name:'Adib', phone:'01933333333', address:'Shyamoli'},
    ]; write(K.contacts, contacts); }
    if(types.length===0){ types=['Phone Charger','Ear Buds','USB Cable','Ear Phone']; write(K.types, types); }
    if(Object.keys(models).length===0){ models={'Phone Charger':['20W','30W'],'Ear Buds':['TWS-1'],'USB Cable':['Type-C'],'Ear Phone':['Wired']}; write(K.models, models); }
    renderManageContacts('');
    renderTypesManage('');
    renderModelsManage('');
    renderSaved('');
  }
  initialRender();
})();

// === UI polish: Show Add buttons only for *new* entries + hide stale dropdowns ===
(function(){
  const ciIncludes = (arr, v) => arr.map(x=>String(x).toLowerCase()).includes(String(v||'').toLowerCase());

  // Types: toggle mtAdd
  const mtI = document.getElementById('mtSearch');
  const mtBtn = document.getElementById('mtAdd');
  function toggleMt(){
    if(!mtI || !mtBtn) return;
    const v = (mtI.value||'').trim();
    const isNew = v && !ciIncludes(types, v);
    mtBtn.style.display = isNew ? 'flex' : 'none';
  }
  if(mtI){
    mtI.addEventListener('input', toggleMt);
    toggleMt();
  }

  // Models: toggle mmAdd – treat as new if not found in ANY model list
  const mmI = document.getElementById('mmSearch');
  const mmBtn = document.getElementById('mmAdd');
  function allModelsFlat(){
    return Object.values(models).flat();
  }
  function toggleMm(){
    if(!mmI || !mmBtn) return;
    const v = (mmI.value||'').trim();
    const isNew = v && !ciIncludes(allModelsFlat(), v);
    mmBtn.style.display = isNew ? 'flex' : 'none';
  }
  if(mmI){
    mmI.addEventListener('input', toggleMm);
    toggleMm();
  }

  // When user clicks Add (type or model), hide any open dropdown menus so
  // stale suggestions from existing products don't linger.
  ['mtAdd','mmAdd','csTypeAdd'].forEach(id=>{
    const b = document.getElementById(id);
    if(!b) return;
    b.addEventListener('click', ()=>{
      document.querySelectorAll('.dd').forEach(dd => dd.classList.add('hidden'));
      // re-evaluate visibility after add (inputs are usually cleared by original logic)
      setTimeout(()=>{ toggleMt(); toggleMm(); }, 0);
    });
  });

  // Also when opening the catalog modal, ensure buttons reflect current input
  const openOnce = setInterval(()=>{
    const el = document.getElementById('manageCatalog');
    if(el){ toggleMt(); toggleMm(); clearInterval(openOnce); }
  }, 200);
})();
// === End UI polish ===========================================================
</script>
<script>

// Ensure full-width Due & Grand wrappers on small screens (fallback for browsers without :has)
function fixDueGrandLayout(){
  try{
    ['due','grand'].forEach(id=>{
      const inp=document.getElementById(id);
      if(!inp) return;
      const wrap=inp.closest('div');
      if(!wrap) return;
      if(window.innerWidth<=820){
        wrap.style.minWidth='100%';
        wrap.style.flexBasis='100%';
        wrap.style.width='100%';
      }else{
        wrap.style.minWidth='';
        wrap.style.flexBasis='';
        wrap.style.width='';
      }
    });
  }catch(e){}
}
window.addEventListener('resize', fixDueGrandLayout);
document.addEventListener('DOMContentLoaded', fixDueGrandLayout);



// Global receipt/download interceptor
document.addEventListener('click', function(ev){
  const el = ev.target.closest('button, a');
  if(!el) return;
  const label = (el.textContent||'').trim().toLowerCase();
  // ignore export csv button
  if(label.includes('export')) return;
  if(!(label.includes('receipt') || label === 'download' || el.classList.contains('rec'))) return;

  // Find invoice from data attribute or nearby text
  let inv = el.getAttribute('data-invoice');
  if(!inv){
    const card = el.closest('.saved-card') || document.getElementById('savedList') || document.body;
    const text = (card.textContent||'');
    const m = text.match(/Invoice\\s+([\\w-]+)/i);
    if(m) inv = m[1];
  }
  if(!inv) return;

  try{
    const entries = JSON.parse(localStorage.getItem('nrt_entries_v2') || '[]');
    const e = entries.find(x => String((x.invoice||'')).trim() === String(inv).trim());
    if(e && typeof downloadReceiptPDF === 'function'){
      ev.preventDefault(); ev.stopPropagation();
      downloadReceiptPDF(e);
      return false;
    }
  }catch(_){}
}, true);

</script>
<script>document.getElementById('inventoryBtn')&& (document.getElementById('inventoryBtn').onclick = async ()=>{location.href='inventory.html'});</script>
<!-- Auto-PDF dependencies (injected once) -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script>
function downloadReceiptPDF(entry){
  try{
    // Create hidden container that won't cause reflow/flicker
    const wrap = document.createElement('div');
    wrap.id = 'nrt-pdf-receipt';
    // Prevent layout shifts: fixed, invisible, no pointer events
    wrap.style.cssText = [
      'position:fixed','top:0','left:0','z-index:-1','opacity:0',
      'width:794px','background:#fff','padding:28px',
      'font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial'
    ].join(';');

    const safe = (v)=> (v==null? '' : String(v));

    // Build Items rows
    const itemsHtml = (entry.items||[]).map((i,idx)=>`
      <tr>
        <td>${idx+1}</td>
        <td>${safe(i.type)}</td>
        <td>${safe(i.model)}</td>
        <td class="r">${Number(i.qty||0)}</td>
        <td class="r">${Number(i.price||0).toFixed(2)}</td>
        <td class="r">${Number(i.total || (Number(i.qty||0)*Number(i.price||0))).toFixed(2)}</td>
      </tr>
    `).join('');

    const customerName = safe(entry.name || entry.customer || '');
    const customerPhone = safe(entry.phone || entry.number || entry.mobile || '');
    const customerAddr = safe(entry.address || '');

    wrap.innerHTML = `
      <style>
        .hdr h1{margin:0;font-size:22px;font-weight:800;letter-spacing:0.2px}
        .muted{color:#64748b}
        .sec{margin-top:14px}
        .label{font-size:12px;color:#64748b}
        .value{font-weight:600}
        .kv{display:grid;grid-template-columns:140px 1fr;gap:6px 14px;margin-top:8px}
        table{width:100%;border-collapse:collapse;margin-top:8px;font-size:13px}
        th,td{padding:8px 10px;border-bottom:1px solid #e5e7eb}
        thead th{background:#f8fafc;text-align:left}
        .r{text-align:right}
        .totals{margin-top:12px;display:grid;grid-template-columns:1fr 220px;gap:8px}
        .totals .box{border:1px solid #e5e7eb;border-radius:10px;padding:10px 12px;background:#fbfdff}
        .totals .box .line{display:flex;justify-content:space-between;margin:4px 0}
        .grand{font-weight:800}
        .sig{margin-top:60px;text-align:center;color:#6b7280;font-size:12px}
        .sig .line{margin-top:28px;border-top:1px dashed #cbd5e1;width:260px;margin-left:auto;margin-right:auto;padding-top:6px}
      </style>

      <!-- Company Header (left-aligned) -->
      <div class="hdr">
        <h1>ChinoMart BD</h1>
        <div class="muted">chinomartbd@gmail.com</div>
        <div class="muted">Road 04, Shymoli, Sher-E-Bangla Nagar, Dhaka, Bangladesh</div>
      </div>

      <!-- Customer / Invoice Details -->
      <div class="sec">
        <div class="kv">
          <div class="label">Invoice No.</div><div class="value">${safe(entry.invoice)}</div>
          <div class="label">Date</div><div class="value">${safe(entry.date)}</div>
          <div class="label">Customer Name</div><div class="value">${customerName}</div>
          <div class="label">Phone</div><div class="value">${customerPhone}</div>
          <div class="label">Address</div><div class="value">${customerAddr)}</div>
        </div>
      </div>

      <!-- Items Table -->
      <div class="sec">
        <table>
          <thead>
            <tr><th>#</th><th>Product Type</th><th>Model</th><th class="r">Qty</th><th class="r">Price</th><th class="r">Line Total</th></tr>
          </thead>
          <tbody>${itemsHtml}</tbody>
        </table>
      </div>

      <!-- Totals -->
      <div class="sec totals">
        <div></div>
        <div class="box">
          <div class="line"><span>Discount</span><span>${Number(entry.discount||0).toFixed(2)}</span></div>
          <div class="line grand"><span>Grand Total</span><span>${Number(entry.grand||0).toFixed(2)}</span></div>
          <div class="line"><span>Due</span><span>${Number(entry.due||0).toFixed(2)}</span></div>
        </div>
      </div>

      <!-- Signature centered -->
      <div class="sig">
        <div class="line">Authorized Signature</div>
      </div>
    `;

    document.body.appendChild(wrap);

    // Render and save without layout shift
    requestAnimationFrame(()=>{
      html2canvas(wrap, {scale: 2, useCORS:true}).then(canvas => {
        const img = canvas.toDataURL('image/png');
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({orientation:'portrait', unit:'pt', format:'a4'});
        const pageW = pdf.internal.pageSize.getWidth();
        const pageH = pdf.internal.pageSize.getHeight();
        const ratio = Math.min(pageW / canvas.width, pageH / canvas.height);
        const w = canvas.width * ratio;
        const h = canvas.height * ratio;
        pdf.addImage(img, 'PNG', (pageW - w)/2, 24, w, h);
        const name = (entry.invoice ? String(entry.invoice) : 'receipt') + '.pdf';
        pdf.save(name);
        try{ window.nrtIOSNotify && nrtIOSNotify({title:'Receipt Downloaded', subtitle:name, icon:'🧾', right:'✓'}); }catch(_){}
        wrap.remove();
      }).catch(()=>{ wrap.remove(); });
    });
  }catch(e){ console.error(e); }
}
</script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
<script>
function generateReceiptPDF(e){
  const fmtBDT = (n) => `${Number(n||0).toFixed(2)} BDT`;
  try{
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({orientation:'portrait', unit:'pt', format:'a4'});

    const W = doc.internal.pageSize.getWidth();
    let y = 36;

    // Company Header (Top Left)
    doc.setFont('helvetica','bold'); doc.setFontSize(16);
    doc.text('ChinoMart BD', 36, y);
    doc.setFont('helvetica','normal'); doc.setFontSize(11);
    y += 16; doc.text('chinomartbd@gmail.com', 36, y);
    y += 14; doc.text('Road 04, Shymoli, Sher-E-Bangla Nagar, Dhaka, Bangladesh', 36, y);

    // Customer / Invoice Details
    y += 26;
    doc.setFont('helvetica','bold'); doc.setFontSize(12); doc.text('Invoice Details', 36, y);
    y += 8; doc.setFont('helvetica','normal'); doc.setFontSize(11);

    const kv = [
      ['Invoice No.', String(e.invoice||'')],
      ['Date', String(e.date||'')],
      ['Customer Name', String(e.store || e.name || e.customer || '')],
      ['Phone', String(e.phone||'')],
      ['Address', String(e.address||'')],
    ];
    const leftX = 36, gapY = 16, labelW = 110;
    kv.forEach(row => {
      y += gapY;
      doc.setFont('helvetica','normal'); doc.setTextColor(100);
      doc.text(row[0], leftX, y);
      doc.setFont('helvetica','bold'); doc.setTextColor(0);
      doc.text(String(row[1]), leftX + labelW, y);
    });

    // Items Table
    y += 18;
    const rows = (e.items||[]).map((i, idx) => {
      const qty = String(parseInt(i.qty||0, 10));           // Qty integer
      const price = fmtBDT(i.price);
      const total = fmtBDT((i.total!=null? i.total : Number(i.qty||0)*Number(i.price||0)));
      return [ String(idx+1), String(i.type||''), String(i.model||''), qty, price, total ];
    });

    doc.autoTable({
      startY: y,
      head: [['#','Product Type','Model','Qty','Price','Line Total']],
      body: rows,
      styles: { font:'helvetica', fontSize: 10, cellPadding: 6 },
      theme: 'grid',
      columnStyles: {
        0: { halign:'left', cellWidth: 24 },
        1: { halign:'left' },
        2: { halign:'left' },
        3: { halign:'right', cellWidth: 40 },
        4: { halign:'right', cellWidth: 90 },
        5: { halign:'right', cellWidth: 100 },
      },
      headStyles: { fillColor: [248,250,252], textColor: 0 },
      didParseCell: function(data){
        if(data.section === 'head'){
          if([3,4,5].includes(data.column.index)) data.cell.styles.halign = 'right';
          else data.cell.styles.halign = 'left';
        }
      }
    });

    let endY = doc.lastAutoTable ? doc.lastAutoTable.finalY : y + 18;

    // Totals (right side box) with conditional rows
    const boxX = W - 280 - 36;
    const boxY = endY + 14;
    const boxW = 280, boxPad = 10;

    doc.setDrawColor(229,231,235); doc.setFillColor(251,253,255);
    doc.roundedRect(boxX, boxY, boxW, 110, 6, 6, 'S');

    const discount = Number(e.discount||0);
    const due = Number(e.due||0);
    const lines = [];
    if (discount > 0) lines.push(['Discount', fmtBDT(discount)]);
    lines.push(['Grand Total', fmtBDT(e.grand)]);
    if (due > 0) lines.push(['Due', fmtBDT(due)]);

    let ly = boxY + boxPad + 14;
    lines.forEach(([label, val], i) => {
      doc.setFont('helvetica', label==='Grand Total' ? 'bold':'normal'); doc.setFontSize(12);
      doc.text(label, boxX + boxPad, ly);
      doc.text(String(val), boxX + boxW - boxPad, ly, { align: 'right' });
      ly += 18;
    });

    // Signature centered at bottom
    const bottomY = Math.max(ly + 44, boxY + 150);
    const cx = W/2;
    doc.setDrawColor(203,213,225); doc.line(cx-130, bottomY, cx+130, bottomY);
    doc.setFont('helvetica','normal'); doc.setFontSize(11);
    doc.text('Authorized Signature', cx, bottomY + 14, { align: 'center' });

    const name = (e.invoice ? String(e.invoice) : 'receipt') + '.pdf';
    doc.save(name);
    try{ window.nrtIOSNotify && nrtIOSNotify({title:'Receipt Downloaded', subtitle:name, icon:'🧾', right:'✓'}); }catch(_){}
  }catch(err){
    console.error('PDF error', err);
    try{ nrtIOSNotify({title:'Download Failed', subtitle:'Could not generate receipt PDF.', icon:'⚠️', right:'!'}); }catch(_){ alert('Could not generate receipt PDF.'); }
  }
}
</script>
<script id="nrt-dropdown-portalizer">
(function(){
  function isVisible(el){
    return !!el && (el.offsetParent !== null || (getComputedStyle(el).position==='fixed' && el.getBoundingClientRect().width>0));
  }
  function isOpen(dd){
    const s = getComputedStyle(dd);
    return s.display !== 'none' && (dd.classList.contains('open') || s.visibility !== 'hidden');
  }
  function anchorOf(dd){
    // Prefer closest .combo/.search; else previousElementSibling; else parent
    let a = dd.closest('.combo,.search');
    if(!a && dd.parentElement) a = dd.parentElement;
    return a;
  }
  function place(dd){
    const a = anchorOf(dd); if(!a) return;
    const r = a.getBoundingClientRect();
    dd.style.position = 'fixed';
    dd.style.left = r.left + 'px';
    dd.style.top  = (r.bottom + 6) + 'px';
    dd.style.width = r.width + 'px';
    dd.style.maxWidth = r.width + 'px';
    dd.style.zIndex = '99999';
  }
  function tryPlace(dd){
    if(!dd) return;
    if(isOpen(dd)){ place(dd); }
  }
  function hook(container){
    const dd = container.querySelector('.dropdown'); if(!dd) return;
    // Capture focus/click/input to place
    ['focus','click','input'].forEach(ev => {
      container.addEventListener(ev, function(){ tryPlace(dd); }, true);
    });
    // Observe class/style changes (e.g., .open)
    const obs = new MutationObserver(()=>tryPlace(dd));
    obs.observe(dd, {attributes:true, attributeFilter:['class','style']});
  }
  function init(){
    document.querySelectorAll('.combo,.search').forEach(hook);
  }
  // Global resize/scroll -> reposition any visible dropdowns
  function repositionAll(){
    document.querySelectorAll('.dropdown').forEach(dd => { if(isOpen(dd)) place(dd); });
  }
  window.addEventListener('resize', repositionAll, {passive:true});
  window.addEventListener('scroll', repositionAll, {passive:true, capture:true});
  // init now and also after DOM load just in case
  try{ init(); }catch(e){}
  document.addEventListener('DOMContentLoaded', init, {once:true});
})();
</script>
<script id="nrt-close-dd-and-reset-discount">
// Close Product Type/Model dropdowns when clicking anywhere else
(function(){
  function closeRowDropdowns(ev){
    const target = ev.target;
    // Only affect item-row dropdowns (not contact etc.)
    document.querySelectorAll('#itemsBody .dropdown').forEach(dd => {
      const combo = dd.closest('.combo');
      if(!combo) return;
      // If click is outside the combo (input + dropdown), hide
      if(!combo.contains(target)){ dd.classList.add('hidden'); }
    });
  }
  // Use mousedown so it fires before focus shifts
  document.addEventListener('mousedown', closeRowDropdowns, true);
})();

// After Submit, reset discount controls like other fields
(function(){
  const btn = document.getElementById('submit');
  if(btn){
    btn.addEventListener('click', function(){
      // Run after the original submit handler
      setTimeout(function(){
        const dv = document.getElementById('discountVal');
        const dt = document.getElementById('discountType');
        if(dv) dv.value = '0';
        if(dt) dt.value = '%';
        if(typeof recalcGrand === 'function') recalcGrand();
      }, 0);
    }, false);
  }
})();
</script>

<script id="nrt-ios-toast-js">
(function(){
  if(window.nrtIOSNotify) return;
  function ensureNode(){
    let node = document.getElementById('nrt-ios-toast');
    if(!node){
      const wrap = document.createElement('div');
      wrap.innerHTML = `<div id=\"nrt-ios-toast\" aria-live=\"polite\" aria-atomic=\"true\" style=\"display:none\">  <div class=\"icon\" id=\"nrt-ios-toast-icon\">⬇️</div>  <div class=\"text\">    <div class=\"title\" id=\"nrt-ios-toast-title\">Downloaded</div>    <div class=\"subtitle\" id=\"nrt-ios-toast-sub\">Your file is saved.</div>  </div>  <div class=\"tick\" id=\"nrt-ios-toast-right\">✓</div></div>`;
      document.body.appendChild(wrap.firstElementChild);
      node = document.getElementById('nrt-ios-toast');
    }
    return node;
  }
  function nrtIOSNotify({title="Done", subtitle="", icon="⬇️", right="✓", duration=2200}={}){
    const node = ensureNode();
    node.style.display = 'grid';
    node.querySelector('#nrt-ios-toast-title').textContent = title;
    node.querySelector('#nrt-ios-toast-sub').textContent = subtitle||"";
    node.querySelector('#nrt-ios-toast-icon').textContent = icon||"";
    node.querySelector('#nrt-ios-toast-right').textContent = right||"✓";
    // show
    requestAnimationFrame(()=> node.classList.add('show'));
    clearTimeout(node._t);
    node._t = setTimeout(()=>{
      node.classList.remove('show');
      // hide after transition
      setTimeout(()=>{ node.style.display='none'; }, 400);
    }, duration);
  }
  window.nrtIOSNotify = nrtIOSNotify;
  // Optional: replace alert() with banner-styled error to match iPhone-like look
  window.nrtAlert = function(msg){ nrtIOSNotify({title:"Notice", subtitle:String(msg||""), icon:"🔔", right:""}); };
})();
</script>


<script>
  // iPhone-style banner alerts
  window.alert = function(msg){
    if (typeof nrtIOSNotify === 'function') {
      nrtIOSNotify({ title: 'Notice', subtitle: String(msg||''), icon: '🔔', right: '' });
    } else {
      // fallback
      console.log('ALERT:', msg);
    }
  };
</script>


<style>
/* iOS-style confirm sheet */
#nrt-ios-confirm-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);backdrop-filter:saturate(140%) blur(2px);display:none;align-items:center;justify-content:center;z-index:99999}
#nrt-ios-confirm{width:min(94vw,420px);background:#f8f8fb;border-radius:18px;box-shadow:0 20px 60px rgba(0,0,0,.25);overflow:hidden;border:1px solid #e5e7eb}
#nrt-ios-confirm .body{padding:18px 18px 8px;color:#0f172a}
#nrt-ios-confirm .title{font-weight:700;font-size:16px;margin:0 0 6px}
#nrt-ios-confirm .msg{font-size:14px;color:#374151;margin:0}
#nrt-ios-confirm .actions{display:grid;grid-template-columns:1fr 1fr}
#nrt-ios-confirm button{appearance:none;border:0;padding:14px 4px;font-weight:700;background:#fff}
#nrt-ios-confirm button+button{border-left:1px solid #e5e7eb}
#nrt-ios-confirm .cancel{color:#111827}
#nrt-ios-confirm .ok{color:#0ea5e9}
#nrt-ios-confirm .danger{color:#ef4444}
</style>
<script>
(function(){
  // Create confirm nodes once
  function ensureConfirm(){
    let back = document.getElementById('nrt-ios-confirm-backdrop');
    if(!back){
      const wrap = document.createElement('div');
      wrap.innerHTML = `
      <div id="nrt-ios-confirm-backdrop" role="dialog" aria-modal="true">
        <div id="nrt-ios-confirm">
          <div class="body">
            <h3 class="title" id="nrt-confirm-title">Are you sure?</h3>
            <p class="msg" id="nrt-confirm-msg"></p>
          </div>
          <div class="actions">
            <button class="cancel" id="nrt-confirm-cancel">Cancel</button>
            <button class="ok" id="nrt-confirm-ok">OK</button>
          </div>
        </div>
      </div>`;
      document.body.appendChild(wrap.firstElementChild);
    }
    return document.getElementById('nrt-ios-confirm-backdrop');
  }
  window.nrtConfirm = function(message, opts){
    opts = opts||{};
    const back = ensureConfirm();
    back.style.display='flex';
    document.getElementById('nrt-confirm-title').textContent = opts.title || 'Confirm';
    document.getElementById('nrt-confirm-msg').textContent = message || '';
    const okBtn = document.getElementById('nrt-confirm-ok');
    const cancelBtn = document.getElementById('nrt-confirm-cancel');
    okBtn.classList.toggle('danger', !!opts.danger);
    okBtn.textContent = opts.okText || 'OK';
    cancelBtn.textContent = opts.cancelText || 'Cancel';
    return new Promise((resolve)=>{
      function cleanup(res){
        back.style.display='none';
        okBtn.removeEventListener('click', onOk);
        cancelBtn.removeEventListener('click', onCancel);
        back.removeEventListener('click', onBack);
        resolve(res);
      }
      function onOk(e){ e.stopPropagation(); cleanup(true); }
      function onCancel(e){ e.stopPropagation(); cleanup(false); }
      function onBack(e){ if(e.target===back) cleanup(false); }
      okBtn.addEventListener('click', onOk);
      cancelBtn.addEventListener('click', onCancel);
      back.addEventListener('click', onBack);
    });
  };
  // Soft override window.confirm -> async; for legacy, fall back to native but also show banner
  window.confirm = function(message){
    // Try to blockless emulate synchronously using async then; consumers expecting boolean will receive true because JS can't block.
    // To avoid breaking existing logic, we return true only if user clicks OK; otherwise false.
    // We cannot truly block; but we can detect if caller uses the return synchronously. However in our code we migrate calls.
    console.warn('window.confirm intercepted; use await nrtConfirm(message) for best behavior.');
    var result = true;
    // Show UI and set result accordingly after click, but we cannot delay return.
    // Therefore return true but still show UI; our own code paths use await nrtConfirm.
    try{ nrtConfirm(message).then(function(r){ result = r; }); }catch(e){}
    return result;
  };
})(); 
</script>


<!-- NRT Unified UI Fixes (2025-08-23) -->
<style id="nrt-unified-fixes">
/* ===== 1) Header / Titlebar parity ===== */
header, .titlebar{
  min-height:64px !important;
  display:flex !important; align-items:center !important; justify-content:space-between !important;
  gap:12px !important;
}
.titlebar .title{ display:flex !important; flex-direction:column !important; gap:4px !important; }
.titlebar .title-actions{ display:flex !important; align-items:center !important; gap:12px !important; flex-wrap:nowrap !important; }
.titlebar .title-actions .btn{
  display:inline-flex !important; align-items:center !important; justify-content:center !important;
  height:38px !important; padding:10px 16px !important; line-height:1 !important; border-radius:12px !important; margin:0 !important;
}
/* Prevent any legacy offsets */
.titlebar .title-actions, .titlebar .title-actions .btn{ margin-top:0 !important; transform:none !important; }

/* ===== 2) Inputs — standardized height/look ===== */
:root{ --nrt-inp-h:46px; }
input[type="text"], input[type="number"], input[type="date"], select{
  min-height:var(--nrt-inp-h) !important;
  padding:10px 12px !important;
  border-radius:12px !important;
  border:1px solid #e2e8f0 !important;
  background:#fff !important;
  color:#0f172a !important;
  box-shadow:0 1px 2px rgba(15,23,42,.04) !important;
  font-size:14px !important;
}
input[readonly]{
  background:#fff !important; color:#0f172a !important; opacity:1 !important;
  min-height:var(--nrt-inp-h) !important; border:1px solid #e2e8f0 !important;
}
/* Focus */
input[type="text"]:focus, input[type="number"]:focus, input[type="date"]:focus, select:focus{
  outline:none !important; border-color:#a5b4fc !important; box-shadow:0 0 0 4px rgba(165,180,252,.25) !important;
}

/* ===== 3) No clipping for dropdowns/modals ===== */
html, body{ max-width:100%; overflow-x:hidden; }
.wrap, .card, .section, table, tbody, tr, td, th{ overflow:visible !important; }
.dropdown{ z-index:99999 !important; position:absolute; } /* let it float above */

/* ===== 4) Saved Entries buttons — equal sizing, wrap nicely ===== */
.saved-card{ display:flex !important; flex-wrap:wrap !important; gap:10px !important; align-items:center !important; }
.saved-card button{ flex:1 1 auto !important; min-width:90px !important; }
.saved-card .rec{ flex:1 1 100% !important; } /* receipt link can wrap if needed on small screens */

/* ===== 5) Inventory: row expand affordance on mobile ===== */
@media (max-width:600px){
  #inventoryTable tbody tr{ cursor:pointer; position:relative; }
  #inventoryTable tbody tr::after{
    content:"›"; position:absolute; right:10px; top:50%; transform:translateY(-50%);
    color:#64748b; font-weight:800;
  }
  #inventoryTable tbody tr.expanded::after{ content:"▼"; }
}

/* ===== 6) Normalize Invoice / Due / Grand widths ===== */
#invoice, #grand, #due{ min-width:180px !important; width:100% !important; }

/* ===== 7) Desktop app width lock for consistency ===== */
@media (min-width:1280px){
  .wrap{ max-width:1100px !important; margin-left:auto !important; margin-right:auto !important; }
}
</style>

<!-- NRT Unified JS Helpers (safe, optional) -->
<script id="nrt-unified-js">
(function(){
  // 1) Inventory row expand toggle on mobile
  document.addEventListener('click', function(e){
    const tr = e.target?.closest && e.target.closest('#inventoryTable tbody tr');
    if(!tr) return;
    if (window.matchMedia('(max-width: 600px)').matches){
      tr.classList.toggle('expanded');
    }
  }, true);

  // 2) Ensure any .dropdown opened inside a scroll area stays fully visible by raising its z-index
  const raiseDropdown = (dd) => { if(dd){ dd.style.zIndex = '99999'; } };
  document.addEventListener('click', function(e){
    const dd = e.target?.closest && e.target.closest('.dropdown');
    raiseDropdown(dd);
  }, true);
})();
</script>

<!-- NRT: Modal behavior tweaks 2025-08-25 -->
<script id="nrt-modal-logic-20250825">
(function(){
  // 2) Manage Contacts: only one open at a time
  const panel = document.querySelector('#manageContacts');
  if(panel){
    panel.addEventListener('focusin', (e)=>{
      const row = e.target.closest('.rowitem');
      if(!row) return;
      // collapse others
      panel.querySelectorAll('.rowitem.is-expanded').forEach(el=>{
        if(el !== row) el.classList.remove('is-expanded');
      });
      // expand current
      row.classList.add('is-expanded');
    });
    // Also handle taps anywhere inside a row
    panel.addEventListener('click', (e)=>{
      const row = e.target.closest('.rowitem');
      if(!row) return;
      panel.querySelectorAll('.rowitem.is-expanded').forEach(el=>{
        if(el !== row) el.classList.remove('is-expanded');
      });
      row.classList.add('is-expanded');
    });
  }
})();
</script>

</body>